<script>
/* ========== I18N：语言 ========== */
let LANG = 'zh';
const I18N = {
  ui: {
    zh: {
      title_main: "龍運轩ᝰ美食中心", title_sub: "LYX Food Center",
      order: "点餐 / Order", cart: "订单 / Cart",
      table: "桌号", takeaway: "外带", dinein: "堂食",
      add: "加入",
      cat_wonton: "龍兴记ᝰ云吞面", cat_wonton_tip: "点击展开/收起",
      cat_drinks: "饮料", cat_drinks_tip: "全部饮料冰+RM0.20（罐装水除外；我们已把热/冰分开定价）",
      cat_auntie: "婶婶档", cat_auntie_tip: "点击展开/收起",
      cat_gx: "广西卷筒粉", cat_gx_tip: "点击展开/收起",
      note_label: "备注", note_ph: "例如：少甜 / 少冰 / 加辣",
      print: "打印小票",
      done: "完成并统计（群聊）",
      k_orders: "订单笔数", k_items: "售出件数", k_sales: "销售金额",
      tool_today: "查看明细", tool_cat: "分类统计", tool_csv: "导出今日 CSV", tool_del: "删单（需密码）",
      sum_total: "合计 Total",
      alert_pick: "请先选择项目", alert_empty: "没有项目",
      today_none: "（今天暂无）",
      cat_report_title: "分类统计（累计到今天）",
      cat_name_w: "云吞面", cat_name_d: "饮料", cat_name_a: "婶婶档", cat_name_gx: "广西卷筒粉",
      time: "时间", type: "类型",
      // CSV 表头
      csv_time: "时间", csv_table: "桌号", csv_type: "类型",
      csv_items: "项目", csv_total: "合计", csv_note: "备注"
    },
    en: {
      title_main: "LYX Food Center (龍運轩ᝰ)", title_sub: "LYX Food Center",
      order: "Order", cart: "Cart",
      table: "Table", takeaway: "Takeaway", dinein: "Dine-in",
      add: "Add",
      cat_wonton: "Long Hing Kee · Wonton Noodles", cat_wonton_tip: "Tap to expand/collapse",
      cat_drinks: "Drinks", cat_drinks_tip: "Iced + RM0.20 (except canned water; hot/iced priced separately)",
      cat_auntie: "Auntie's Stall", cat_auntie_tip: "Tap to expand/collapse",
      cat_gx: "Guangxi Rice Rolls", cat_gx_tip: "Tap to expand/collapse",
      note_label: "Note", note_ph: "e.g. less sweet / less ice / extra spicy",
      print: "Print Receipt",
      done: "Finish & Send (Group)",
      k_orders: "Orders", k_items: "Items", k_sales: "Sales",
      tool_today: "View Today", tool_cat: "By Category", tool_csv: "Export Today CSV", tool_del: "Delete (password)",
      sum_total: "Total",
      alert_pick: "Please add items first", alert_empty: "No items",
      today_none: "(No orders today)",
      cat_report_title: "Category Summary (today)",
      cat_name_w: "Wonton Noodles", cat_name_d: "Drinks", cat_name_a: "Auntie's Stall", cat_name_gx: "Guangxi Rolls",
      time: "Time", type: "Type",
      csv_time: "Time", csv_table: "Table", csv_type: "Type",
      csv_items: "Items", csv_total: "Total", csv_note: "Note"
    },
    vi: {
      title_main: "Trung tâm Ẩm thực LYX (龍運轩ᝰ)", title_sub: "LYX Food Center",
      order: "Gọi món", cart: "Giỏ hàng",
      table: "Bàn", takeaway: "Mang đi", dinein: "Dùng tại chỗ",
      add: "Thêm",
      cat_wonton: "Mì hoành thánh Long Hing Kee", cat_wonton_tip: "Nhấn để mở/đóng",
      cat_drinks: "Đồ uống", cat_drinks_tip: "Đá + RM0.20 (trừ nước lon; giá nóng/lạnh tách riêng)",
      cat_auntie: "Quầy của Cô", cat_auntie_tip: "Nhấn để mở/đóng",
      cat_gx: "Bánh cuốn Quảng Tây", cat_gx_tip: "Nhấn để mở/đóng",
      note_label: "Ghi chú", note_ph: "vd: ít ngọt / ít đá / thêm cay",
      print: "In hóa đơn",
      done: "Hoàn tất & gửi (nhóm)",
      k_orders: "Đơn", k_items: "Món", k_sales: "Doanh thu",
      tool_today: "Xem hôm nay", tool_cat: "Theo danh mục", tool_csv: "Xuất CSV hôm nay", tool_del: "Xóa (mật khẩu)",
      sum_total: "Tổng",
      alert_pick: "Hãy chọn món trước", alert_empty: "Chưa có món",
      today_none: "(Chưa có đơn hôm nay)",
      cat_report_title: "Tổng hợp theo danh mục (hôm nay)",
      cat_name_w: "Mì hoành thánh", cat_name_d: "Đồ uống", cat_name_a: "Quầy của Cô", cat_name_gx: "Bánh cuốn Quảng Tây",
      time: "Thời gian", type: "Loại",
      csv_time: "Thời gian", csv_table: "Bàn", csv_type: "Loại",
      csv_items: "Món", csv_total: "Tổng", csv_note: "Ghi chú"
    }
  },
  // 菜名翻译（未列出的用中文名）
  items: {
    /* 1) WONTON */
    w_small:{en:"Wonton Noodles (S)",vi:"Mì hoành thánh (Nhỏ)"},
    w_mid:{en:"Wonton Noodles (M)",vi:"Mì hoành thánh (Vừa)"},
    w_big:{en:"Wonton Noodles (L)",vi:"Mì hoành thánh (Lớn)"},
    w_wantan_dry:{en:"Wontons (Dry, per portion)",vi:"Hoành thánh khô (1 phần)"},
    w_wantan_soup:{en:"Wontons (Soup, per portion)",vi:"Hoành thánh nước (1 phần)"},
    w_add3:{en:"Add-on: 3 Wontons",vi:"Thêm: 3 hoành thánh"},
    /* 2) DRINKS */
    d_coffee_hot:{en:"Coffee (Hot)",vi:"Cà phê (Nóng)"},
    d_coffee_ice:{en:"Coffee (Iced)",vi:"Cà phê (Đá)"},
    d_coffeeC_hot:{en:"Coffee C (Hot)",vi:"Cà phê C (Nóng)"},
    d_coffeeC_ice:{en:"Coffee C (Iced)",vi:"Cà phê C (Đá)"},
    d_coffeeO_hot:{en:"Coffee O (Hot)",vi:"Cà phê O (Nóng)"},
    d_coffeeO_ice:{en:"Coffee O (Iced)",vi:"Cà phê O (Đá)"},
    d_milktea_hot:{en:"Milk Tea (Hot)",vi:"Trà sữa (Nóng)"},
    d_milktea_ice:{en:"Milk Tea (Iced)",vi:"Trà sữa (Đá)"},
    d_milkteaC_hot:{en:"Milk Tea C (Hot)",vi:"Trà sữa C (Nóng)"},
    d_milkteaC_ice:{en:"Milk Tea C (Iced)",vi:"Trà sữa C (Đá)"},
    d_milkteaSC_hot:{en:"Salty Milk Tea C (Hot)",vi:"Trà sữa mặn C (Nóng)"},
    d_milkteaSC_ice:{en:"Salty Milk Tea C (Iced)",vi:"Trà sữa mặn C (Đá)"},
    d_milo_hot:{en:"Milo (Hot)",vi:"Milo (Nóng)"},
    d_milo_ice:{en:"Milo (Iced)",vi:"Milo (Đá)"},
    d_miloC_hot:{en:"Milo C (Hot)",vi:"Milo C (Nóng)"},
    d_miloC_ice:{en:"Milo C (Iced)",vi:"Milo C (Đá)"},
    d_miloO_hot:{en:"Milo O (Hot)",vi:"Milo O (Nóng)"},
    d_miloO_ice:{en:"Milo O (Iced)",vi:"Milo O (Đá)"},
    d_canned:{en:"Canned Water",vi:"Nước lon"},
    /* 3) AUNTIE 主食 */
    a_bitter_rice_noodle:{en:"Bitter Gourd Bee Hoon",vi:"Bún khổ qua"},
    a_nasi_ayam:{en:"Nasi Lemak (Chicken)",vi:"Nasi Lemak (gà)"},
    a_nasi_egg:{en:"Nasi Lemak (Egg only)",vi:"Nasi Lemak (trứng)"},
    a_pan_mee:{en:"Pan Mee",vi:"Mì Pan Mee"},
    a_braised_rice:{en:"Braised Rice",vi:"Cơm kho"},
    a_congee_pork:{en:"Fish Congee (Pork)",vi:"Cháo cá (heo)"},
    a_congee_chicken:{en:"Fish Congee (Chicken)",vi:"Cháo cá (gà)"},
    a_mianxian:{en:"Mee Sua",vi:"Mì sợi Mee Sua"},
    a_lu_rou_fan:{en:"Lu Rou Fan",vi:"Cơm thịt kho"},
    a_kuey_teow_soup:{en:"Kuey Teow Soup",vi:"Hủ tiếu nước"},
    /* AUNTIE 加料 */
    a_add_century_egg:{en:"Add-on: Century Egg",vi:"Thêm: trứng bách thảo"},
    a_add_pickled_cucumber:{en:"Pickled Cucumber (add-on)",vi:"Dưa leo chua (thêm)"},
    a_add_pickled_okra:{en:"Pickled Okra (add-on)",vi:"Đậu bắp chua (thêm)"},
    a_add_pickled_bitter:{en:"Pickled Bitter Gourd (add-on)",vi:"Khổ qua chua (thêm)"},
    a_add_pickled_tofu:{en:"Pickled Tofu (add-on)",vi:"Đậu phụ chua (thêm)"},
    a_add_wing:{en:"Fried Chicken Wing",vi:"Cánh gà chiên"},
    a_add_fried_egg:{en:"Fried Egg",vi:"Trứng ốp la"},
    /* 4) Guangxi */
    gx_su:{en:"Plain Rice Roll (kosong)",vi:"Bánh cuốn trơn (kosong)"},
    gx_veg:{en:"Veg Rice Roll",vi:"Bánh cuốn rau"},
    gx_meatveg:{en:"Meat + Veg Rice Roll",vi:"Bánh cuốn thịt + rau"},
    gx_meat:{en:"Meat Rice Roll",vi:"Bánh cuốn thịt"},
    gx_full:{en:"Combo Rice Roll",vi:"Bánh cuốn thập cẩm"},
    gx_spring:{en:"Spring Roll",vi:"Chả giò"},
    gx_taro:{en:"Taro Cake",vi:"Bánh khoai môn"}
  }
};
function t(k){ return I18N.ui[LANG][k]; }
function tItemName(id, fallback){ return I18N.items[id]?.[LANG] || fallback; }

/* ========= 菜单数据（保持你给的） ========= */
const WONTON = [
  {id:"w_small", name:"云吞面（小）", price:6.50},
  {id:"w_mid",   name:"云吞面（中）", price:7.50},
  {id:"w_big",   name:"云吞面（大）", price:8.50},
  {id:"w_wantan_dry",  name:"云吞 干捞（一份）", price:5.00},
  {id:"w_wantan_soup", name:"云吞 汤（一份）",   price:5.00},
  {id:"w_add3",        name:"加料：云吞 ×3",     price:1.00},
];
const DRINKS = [
  {id:"d_coffee_hot",   name:"咖啡（热）",   price:2.30},
  {id:"d_coffee_ice",   name:"咖啡（冰）",   price:2.50},
  {id:"d_coffeeC_hot",  name:"咖啡C（热）",  price:2.50},
  {id:"d_coffeeC_ice",  name:"咖啡C（冰）",  price:2.70},
  {id:"d_coffeeO_hot",  name:"咖啡O（热）",  price:2.00},
  {id:"d_coffeeO_ice",  name:"咖啡O（冰）",  price:2.20},
  {id:"d_milktea_hot",  name:"奶茶（热）",   price:2.30},
  {id:"d_milktea_ice",  name:"奶茶（冰）",   price:2.50},
  {id:"d_milkteaC_hot", name:"奶茶C（热）",  price:2.50},
  {id:"d_milkteaC_ice", name:"奶茶C（冰）",  price:2.70},
  {id:"d_milkteaSC_hot",name:"奶茶咸C（热）",price:2.50},
  {id:"d_milkteaSC_ice",name:"奶茶咸C（冰）",price:2.70},
  {id:"d_milo_hot",     name:"Milo（热）",   price:2.60},
  {id:"d_milo_ice",     name:"Milo（冰）",   price:2.80},
  {id:"d_miloC_hot",    name:"Milo C（热）", price:2.80},
  {id:"d_miloC_ice",    name:"Milo C（冰）", price:3.00},
  {id:"d_miloO_hot",    name:"Milo O（热）", price:2.60},
  {id:"d_miloO_ice",    name:"Milo O（冰）", price:2.80},
  {id:"d_canned",       name:"罐装水",       price:3.00},
];
const AUNTIE = [
  {id:"a_bitter_rice_noodle", name:"苦瓜米粉",           price:6.00},
  {id:"a_nasi_ayam",          name:"Nasi Lemak（有鸡肉）", price:6.00},
  {id:"a_nasi_egg",           name:"Nasi Lemak（只有鸡蛋）", price:3.00},
  {id:"a_pan_mee",            name:"面粉糕",             price:6.00},
  {id:"a_braised_rice",       name:"红烧饭",             price:6.00},
  {id:"a_congee_pork",        name:"鱼粥（猪肉）",        price:6.00},
  {id:"a_congee_chicken",     name:"鱼粥（鸡肉）",        price:6.00},
  {id:"a_mianxian",           name:"面线",               price:6.00},
  {id:"a_lu_rou_fan",         name:"卤肉饭",             price:6.00},
  {id:"a_kuey_teow_soup",     name:"果条汤",             price:6.00},
  // 加料
  {id:"a_add_century_egg",    name:"加皮蛋",             price:1.00},
  {id:"a_add_pickled_cucumber", name:"酸笋瓜",           price:1.50},
  {id:"a_add_pickled_okra",     name:"酸羊角豆",         price:1.50},
  {id:"a_add_pickled_bitter",   name:"酸苦瓜",           price:1.50},
  {id:"a_add_pickled_tofu",     name:"酸豆腐",           price:1.50},
  {id:"a_add_wing",             name:"炸鸡翅膀",         price:3.00},
  {id:"a_add_fried_egg",        name:"煎鸡蛋",           price:1.00},
];
const GUANGXI = [
  {id:"gx_su",      name:"素粉(kosong)",   price:1.00},
  {id:"gx_veg",     name:"蔬菜卷筒粉",     price:2.00},
  {id:"gx_meatveg", name:"菜加肉卷筒粉",   price:3.00},
  {id:"gx_meat",    name:"肉卷筒粉",       price:3.00},
  {id:"gx_full",    name:"全家福卷筒粉",   price:4.00},
  {id:"gx_spring",  name:"春卷",           price:1.00},
  {id:"gx_taro",    name:"芋头米糕",       price:1.00},
];
const ALL = [...WONTON, ...DRINKS, ...AUNTIE, ...GUANGXI];

/* ========== 渲染 ========== */
const cart = {}; // {id: qty}

function itemCard(it){
  const displayName = tItemName(it.id, it.name);
  return `
  <div class="item">
    <div class="left">
      <div class="title">${displayName}</div>
      <div class="sub">RM ${it.price.toFixed(2)}</div>
    </div>
    <div>
      <button class="btn small" onclick="dec('${it.id}')">-</button>
      <div id="qty-${it.id}" class="qty">${cart[it.id]||0}</div>
      <button class="btn small" onclick="inc('${it.id}')">+</button>
      <div style="height:6px"></div>
      <button class="btn add" onclick="inc('${it.id}')">${t('add')}</button>
    </div>
  </div>`;
}
function renderCategory(elId,list){
  document.getElementById(elId).innerHTML = list.map(itemCard).join("");
}
function renderAll(){
  // 标题 & 面板标题翻译
  document.querySelector('header h1 span:nth-child(1)').textContent = t('title_main');
  document.querySelector('header h1 small').textContent = t('title_sub');

  const panelHeads = document.querySelectorAll('.panel h3');
  panelHeads[0].childNodes[0].nodeValue = t('order');
  panelHeads[1].childNodes[0].nodeValue = t('cart');

  // 控件翻译
  document.querySelector('.controls .label').textContent = t('table');
  document.querySelector('#takeaway').nextElementSibling.textContent = t('takeaway');

  // 分类 summary
  const details = document.querySelectorAll('details');
  details[0].querySelector('summary span:nth-child(1)').textContent = t('cat_wonton');
  details[0].querySelector('.cat-sub').textContent = t('cat_wonton_tip');
  details[1].querySelector('summary span:nth-child(1)').textContent = t('cat_drinks');
  details[1].querySelector('.cat-sub').textContent = t('cat_drinks_tip');
  details[2].querySelector('summary span:nth-child(1)').textContent = t('cat_auntie');
  details[2].querySelector('.cat-sub').textContent = t('cat_auntie_tip');
  details[3].querySelector('summary span:nth-child(1)').textContent = t('cat_gx');
  details[3].querySelector('.cat-sub').textContent = t('cat_gx_tip');

  // 右侧按钮 & KPI & 备注
  document.querySelector('.sumrow .print').textContent = t('print');
  document.querySelector('.sumrow .done').textContent = t('done');
  document.querySelector('.section textarea#note').previousElementSibling.textContent = t('note_label');
  document.getElementById('note').placeholder = t('note_ph');
  document.querySelectorAll('.kpi span')[0].textContent = t('k_orders');
  document.querySelectorAll('.kpi span')[1].textContent = t('k_items');
  document.querySelectorAll('.kpi span')[2].textContent = t('k_sales');

  const toolBtns = document.querySelectorAll('.tools .btn');
  toolBtns[0].textContent = t('tool_today');
  toolBtns[1].textContent = t('tool_cat');
  toolBtns[2].textContent = t('tool_csv');
  toolBtns[3].textContent = t('tool_del');

  // 菜单卡片
  renderCategory("cat-wonton", WONTON);
  renderCategory("cat-drinks", DRINKS);
  renderCategory("cat-auntie", AUNTIE);
  renderCategory("cat-guangxi", GUANGXI);

  renderCart();
  showKpis();
}

/* ========== 购物车 & 价格 ========== */
function inc(id){ cart[id]=(cart[id]||0)+1; renderCart(); syncQty(id); }
function dec(id){ if(!cart[id]) return; cart[id]--; if(cart[id]<=0) delete cart[id]; renderCart(); syncQty(id); }
function syncQty(id){ const q=document.getElementById("qty-"+id); if(q) q.textContent=cart[id]||0; }
function priceOf(id){ const it=ALL.find(x=>x.id===id); return it?it.price:0; }
function nameOf(id){
  const it=ALL.find(x=>x.id===id); if(!it) return id;
  return tItemName(id, it.name);
}
function renderCart(){
  const el=document.getElementById("cart");
  let subtotal=0, html="";
  Object.keys(cart).forEach(id=>{
    const qty=cart[id]; const line=priceOf(id)*qty; subtotal+=line;
    html+=`<div>${nameOf(id)} × ${qty} = RM ${line.toFixed(2)}</div>`;
  });
  el.innerHTML = html + `<div class="sum">${t('sum_total')}: RM ${subtotal.toFixed(2)}</div>`;
}

/* ========== 本地统计（按本地年月日） ========== */
function todayKey(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  return "lyx_stats_"+`${yyyy}-${mm}-${dd}`;
}
function loadStats(){
  const raw = localStorage.getItem(todayKey());
  return raw ? JSON.parse(raw) : {orders:0, items:0, sales:0, list:[], cats:{}};
}
function saveStats(st){ localStorage.setItem(todayKey(), JSON.stringify(st)); showKpis(); }
function showKpis(){
  const s=loadStats();
  document.getElementById('kpi-orders').textContent=s.orders;
  document.getElementById('kpi-items').textContent=s.items;
  document.getElementById('kpi-sales').textContent="RM "+(s.sales||0).toFixed(2);
}

/* ========== 完成并统计 → WhatsApp 选群（保存 items 明细供多语言导出） ========== */
function finishAndSend(){
  if(Object.keys(cart).length===0){ alert(t('alert_pick')); return; }

  const table = document.getElementById('tableNo').value || "-";
  const type  = document.getElementById('takeaway').checked ? t('takeaway') : t('dinein');
  const note  = (document.getElementById('note').value||"").trim();

  // 计算本单
  let subtotal=0, itemsCount=0, lines=[], itemsArr=[];
  Object.keys(cart).forEach(id=>{
    const qty=cart[id]; itemsCount+=qty;
    const lineAmt = priceOf(id)*qty; subtotal+=lineAmt;
    // 当前语言的行文本
    lines.push(`- ${nameOf(id)} × ${qty} = RM ${lineAmt.toFixed(2)}`);
    // 结构化保存，供将来用“当前语言”重建
    itemsArr.push({id, qty, amount: +lineAmt.toFixed(2)});
  });

  // 写入统计（总体+分类）
  const st=loadStats();
  st.orders += 1; st.items += itemsCount; st.sales = +(st.sales + subtotal).toFixed(2);
  const catMap={
    [I18N.ui.zh.cat_name_w]:WONTON.map(x=>x.id),
    [I18N.ui.zh.cat_name_d]:DRINKS.map(x=>x.id),
    [I18N.ui.zh.cat_name_a]:AUNTIE.map(x=>x.id),
    [I18N.ui.zh.cat_name_gx]:GUANGXI.map(x=>x.id),
  };
  st.cats = st.cats || {};
  Object.entries(catMap).forEach(([cat,ids])=>{
    let c=0,s=0; ids.forEach(id=>{ if(cart[id]){ c+=cart[id]; s+=cart[id]*priceOf(id);} });
    if(!st.cats[cat]) st.cats[cat]={count:0,amount:0};
    st.cats[cat].count += c; st.cats[cat].amount = +(st.cats[cat].amount + s).toFixed(2);
  });
  st.list.push({
    time:new Date().toLocaleString(),
    table, type,
    lines,                 // 兼容旧版
    items_struct: itemsArr,// 新增：结构化明细
    total:subtotal, note
  });
  saveStats(st);

  // 组合消息并打开 WhatsApp
  const NL = "\n";
  const msg = [
    `${t('title_main')} 订单`,
    `${t('table')}: ${table}`,
    `${t('type')}: ${type}`, "",
    LANG==='en'?"Items:":"明细:"
  ].concat(lines).concat(["",`${t('sum_total')}: RM ${subtotal.toFixed(2)}`, note?(t('note_label')+": "+note):""]).join(NL);

  const url = "https://wa.me/?text=" + encodeURIComponent(msg);
  let opened = false;
  try { window.open(url, '_blank'); opened = true; } catch(e){}
  if(!opened){ location.href = url; }
  setTimeout(()=>{ // 兜底 App-Scheme
    try { window.location.href = "whatsapp://send?text=" + encodeURIComponent(msg); } catch(e){}
  }, 600);

  // 清空购物车
  for(const k in cart) delete cart[k];
  renderCart(); showKpis();
}

/* ========== 打印小票 ========== */
function printReceipt(){
  if(Object.keys(cart).length===0){ alert(t('alert_empty')); return; }
  const area=document.getElementById('print-area'); area.classList.remove('hidden');
  const table=document.getElementById('tableNo').value||'-';
  const type=document.getElementById('takeaway').checked?t('takeaway'):t('dinein');
  let subtotal=0, body='';
  Object.keys(cart).forEach(id=>{
    const qty=cart[id], line=priceOf(id)*qty; subtotal+=line;
    body+=`<div>${nameOf(id)} × ${qty}<span style="float:right">RM ${line.toFixed(2)}</span></div>`;
  });
  area.innerHTML=`
  <div style="max-width:340px;margin:0 auto;font-size:13px;line-height:1.35">
    <div style="text-align:center;font-weight:900">${t('title_main')}<br><small>${t('title_sub')}</small></div>
    <div>${t('time')}: ${new Date().toLocaleString()}</div>
    <div>${t('table')}: ${table}</div>
    <div>${t('type')}: ${type}</div>
    <hr>${body}<hr>
    <div style="font-weight:900">${t('sum_total')}: RM ${subtotal.toFixed(2)}</div>
  </div>`;
  window.print(); area.classList.add('hidden');
}

/* ========== 查看 / 导出 / 删除 ========== */
function viewToday(){
  const st=loadStats();
  const toLines = (r)=>{
    // 优先用结构化明细，用当前语言重建
    if (Array.isArray(r.items_struct) && r.items_struct.length){
      return r.items_struct.map(it=>`- ${nameOf(it.id)} × ${it.qty} = RM ${(+it.amount).toFixed(2)}`);
    }
    // 兼容旧数据：直接使用已保存的行文本
    return (r.lines||[]);
  };
  const lines=(st.list||[]).map((r,i)=>{
    const rebuilt = toLines(r);
    return `${i+1}. [${r.time}] ${r.table}/${r.type}\n   ${rebuilt.join("\n   ")}\n   ${I18N.ui.en.sum_total}: RM ${(+r.total).toFixed(2)}${r.note?("\n   "+t('note_label')+": "+r.note):""}`;
  }).join("\n\n");
  alert((lines||t('today_none')) + `\n\n${t('k_orders')}: ${st.orders} | ${t('k_items')}: ${st.items} | ${t('k_sales')}: RM ${st.sales.toFixed(2)}`);
}
function viewByCategory(){
  const st=loadStats(); const c=st.cats||{};
  const w = I18N.ui.zh.cat_name_w, d = I18N.ui.zh.cat_name_d, a = I18N.ui.zh.cat_name_a, gx = I18N.ui.zh.cat_name_gx;
  const mapName = {
    [w]: I18N.ui[LANG].cat_name_w, [d]: I18N.ui[LANG].cat_name_d,
    [a]: I18N.ui[LANG].cat_name_a, [gx]: I18N.ui[LANG].cat_name_gx
  };
  const msg = [
    t('cat_report_title'),
    `${mapName[w]}：${(c[w]?.count||0)}  / RM ${(c[w]?.amount||0).toFixed(2)}`,
    `${mapName[d]}：${(c[d]?.count||0)}  / RM ${(c[d]?.amount||0).toFixed(2)}`,
    `${mapName[a]}：${(c[a]?.count||0)}  / RM ${(c[a]?.amount||0).toFixed(2)}`,
    `${mapName[gx]}：${(c[gx]?.count||0)} / RM ${(c[gx]?.amount||0).toFixed(2)}`
  ].join("\n");
  alert(msg);
}

/* ========== 导出 CSV（表头 & 项目随语言） ========== */
function exportCSV(){
  const k=todayKey(), st=JSON.parse(localStorage.getItem(k)||"{}");

  const headers = [
    t('csv_time'),
    t('csv_table'),
    t('csv_type'),
    t('csv_items'),
    t('csv_total'),
    t('csv_note')
  ];
  const rows=[headers.join(",")];

  (st.list||[]).forEach(r=>{
    // 用当前语言重建项目明细
    let itemsStr = "";
    if (Array.isArray(r.items_struct) && r.items_struct.length){
      itemsStr = r.items_struct.map(it=>`${nameOf(it.id)} × ${it.qty} = RM ${(+it.amount).toFixed(2)}`).join(" | ");
    } else {
      // 旧数据回退
      itemsStr = (r.lines||[]).join(" | ");
    }
    rows.push([
      r.time,
      r.table,
      r.type,
      itemsStr.replace(/,/g," "), // 避免逗号破列
      "RM "+(+r.total).toFixed(2),
      (r.note||"").replace(/,/g," ")
    ].join(","));
  });

  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`lyx_today_${todayKey().slice(-10)}.csv`;
  a.click();
}

const DELETE_PWD="Lyx115599$";
function deleteWithPwd(){
  const p=prompt("输入密码以清空今天统计");
  if(p!==DELETE_PWD){ alert("密码错误"); return; }
  localStorage.removeItem(todayKey());
  showKpis(); alert("已清空今天统计");
}

/* ========== 语言按钮事件 ========== */
function setLang(next){
  LANG = next;
  document.getElementById('btn-zh').classList.toggle('active', next==='zh');
  document.getElementById('btn-en').classList.toggle('active', next==='en');
  document.getElementById('btn-vi').classList.toggle('active', next==='vi');
  renderAll();
}
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById('btn-zh').addEventListener('click', ()=>setLang('zh'));
  document.getElementById('btn-en').addEventListener('click', ()=>setLang('en'));
  document.getElementById('btn-vi').addEventListener('click', ()=>setLang('vi'));
  renderAll(); showKpis();
});
</script>
