<!DOCTYPE html>
<html lang="zh" translate="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>龍運轩ᝰ美食中心 · LYX Food Center</title>
<meta name="color-scheme" content="light dark">
<style>
:root{
  --bg:#f7f8fb;--card:#fff;--ink:#0f172a;--mut:#6b7280;--line:#e5e7eb;
  --brand:#0ea5e9;--ok:#059669;--accent:#f59e0b;
  --shadow:0 8px 24px rgba(2,8,23,.06)
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{text-decoration:none;color:inherit}
.wrap{max-width:1200px;margin:20px auto;padding:0 12px 24px}
header{position:sticky;top:0;z-index:9;background:linear-gradient(180deg,#0ea5e9,#0284c7);color:#fff;padding:14px 16px}
h1{margin:0;font-size:20px;letter-spacing:.5px;display:flex;gap:10px;align-items:baseline}
h1 small{opacity:.9}
.lang{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.lang button{padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.45);background:rgba(255,255,255,.12);color:#fff;cursor:pointer;font-weight:700}
.lang button.active{background:#fff;color:#0b3a55}

.grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.panel{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
.panel h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px;display:flex;align-items:center;gap:8px}
.section{padding:12px 12px 18px}

.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin:0 6px 10px}
.label{font-weight:700}
.input{padding:10px;border:1px solid var(--line);border-radius:12px;min-width:140px}
.switch{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px 10px;background:#fff}

details{border:1px solid var(--line);border-radius:14px;margin:10px 0;background:#fff}
summary{list-style:none;cursor:pointer;padding:12px 14px;border-radius:14px;display:flex;justify-content:space-between;align-items:center;font-weight:900;background:#fff7ed;border-left:4px solid var(--accent)}
summary::marker,summary::-webkit-details-marker{display:none}
.cat-sub{color:#a16207;font-weight:600;font-size:12px}

/* 菜品网格：默认两列（手机也两列），极窄屏才一列 —— 宽度减半 */
.cards{
  padding:10px;
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:10px;
}
@media (max-width:380px){ .cards{grid-template-columns:1fr} }

.item{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;display:flex;gap:12px;align-items:center}
.item .left{flex:1}
.title{font-weight:900}
.sub{color:var(--mut);font-size:12px;line-height:1.25}
.qty{min-width:52px;text-align:center;font-weight:900;font-size:18px}

.btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
.btn.small{padding:10px 14px;font-size:18px;border-width:2px}
.btn.add{background:var(--brand);border-color:var(--brand);color:#fff;font-weight:800}

.sticky{position:sticky;top:86px}
.sumrow{display:flex;gap:10px;margin-top:10px}
.sumrow .btn.print{flex:1;background:#1d4ed8;border-color:#1d4ed8;color:#fff}
.sumrow .btn.done{flex:3;background:var(--ok);border-color:var(--ok);color:#fff}
.note{width:100%;min-height:68px;border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px}
.sum{border-top:1px dashed var(--line);padding-top:10px;margin-top:10px}

.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
.kpi{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;text-align:center}
.kpi b{display:block;font-size:18px}

.tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.hidden{display:none}

/* 分类统计表 */
.table{width:100%;border-collapse:collapse;margin-top:8px;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{border-bottom:1px solid var(--line);padding:10px;font-size:14px;text-align:left}
.table th{background:#f8fafc}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#ecfeff;color:#075985;border:1px solid #bae6fd;font-size:12px}
</style>
</head>
<body>
<header>
  <h1><span data-i18n="appName">龍運轩ᝰ美食中心</span> <small data-i18n="appNameEn">LYX Food Center</small></h1>
  <div class="lang">
    <button id="btn-zh" class="active" onclick="applyLang('zh')" data-i18n="lang_zh">中文</button>
    <button id="btn-en" onclick="applyLang('en')" data-i18n="lang_en">English</button>
    <button id="btn-vi" onclick="applyLang('vi')" data-i18n="lang_vi">Tiếng Việt</button>
  </div>
</header>

<div class="wrap grid">
  <!-- 左侧：下单 -->
  <section class="panel">
    <h3 data-i18n="orderTitle">点餐 / Order</h3>
    <div class="section">
      <div class="controls">
        <label class="label" data-i18n="tableNo">桌号</label>
        <input id="tableNo" class="input" placeholder="A1">
        <label class="switch">
          <input type="checkbox" id="takeaway">
          <span data-i18n="takeaway">外带</span>
        </label>
      </div>

      <!-- 龍兴记ᝰ云吞面 -->
      <details>
        <summary>
          <span data-i18n="cat_wonton">龍兴记ᝰ云吞面</span>
          <span class="cat-sub" data-i18n="subTap">点击展开/收起</span>
        </summary>
        <div class="cards" id="cat-wonton"></div>
      </details>

      <!-- 饮料 -->
      <details>
        <summary>
          <span data-i18n="cat_drinks">饮料</span>
          <span class="cat-sub" data-i18n="ruleCaption">规则见小字</span>
        </summary>
        <div class="section" style="padding:10px 14px">
          <div class="sub" data-i18n="rule_ice">全部饮料「冰」另加 RM0.20（罐装水除外）</div>
          <div class="sub" data-i18n="rule_canned">罐装水统一 RM3.00</div>
        </div>
        <div class="cards" id="cat-drinks"></div>
      </details>

      <!-- 婶婶档 -->
      <details>
        <summary>
          <span data-i18n="cat_auntie">婶婶档</span>
          <span class="cat-sub" data-i18n="subTap">点击展开/收起</span>
        </summary>
        <div class="cards" id="cat-auntie"></div>
      </details>

      <!-- 广西卷筒粉 -->
      <details>
        <summary>
          <span data-i18n="cat_gx">广西卷筒粉</span>
          <span class="cat-sub" data-i18n="subTap">点击展开/收起</span>
        </summary>
        <div class="cards" id="cat-gx"></div>
      </details>
    </div>
  </section>

  <!-- 右侧：购物车/统计/导出 -->
  <aside class="panel sticky">
    <h3 data-i18n="cartTitle">订单 / Cart</h3>
    <div id="cart" class="section"></div>
    <div class="section">
      <label class="label" data-i18n="notes">备注（例：少甜 / 少冰 / 加辣）</label>
      <textarea id="note" class="note" placeholder=""></textarea>

      <div class="sumrow">
        <button class="btn print" onclick="printReceipt()" data-i18n="print">打印小票</button>
        <button class="btn done" onclick="finishAndSend()" data-i18n="complete_stats_group">完成并统计（群聊）</button>
      </div>

      <div class="kpis">
        <div class="kpi"><span data-i18n="ordersCount">订单笔数</span><b id="kpi-orders">0</b></div>
        <div class="kpi"><span data-i18n="itemsSold">售出件数</span><b id="kpi-items">0</b></div>
        <div class="kpi"><span data-i18n="salesAmount">销售金额</span><b id="kpi-sales">RM 0.00</b></div>
      </div>

      <div class="tools">
        <button class="btn" onclick="viewToday()" data-i18n="viewDetail">查看明细</button>
        <button class="btn" onclick="toggleBreakdown()" id="btn-break" data-i18n="toggleBreak">分类明细</button>
        <button class="btn" onclick="exportCSV('today')" data-i18n="exportToday">导出今日 CSV</button>
        <button class="btn" onclick="exportCSV('week')" data-i18n="exportWeek">导出本周 CSV</button>
        <button class="btn" onclick="exportCSV('month')" data-i18n="exportMonth">导出本月 CSV</button>
        <button class="btn" onclick="deleteWithPwd()" data-i18n="deleteNeedPwd">删单（需密码）</button>
      </div>

      <div id="breakdown" class="hidden">
        <table class="table">
          <thead>
          <tr>
            <th data-i18n="cat">分类</th>
            <th data-i18n="qty">数量</th>
            <th data-i18n="amount">金额</th>
          </tr>
          </thead>
          <tbody id="bd-body"></tbody>
          <tfoot>
          <tr>
            <th data-i18n="total">合计</th>
            <th id="bd-q">0</th>
            <th id="bd-a">RM 0.00</th>
          </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </aside>
</div>

<!-- 打印区 -->
<div id="print-area" class="hidden"></div>

<script>
/* ============ 多语言 ============ */
const i18n = {
  zh: {
    appName:"龍運轩ᝰ美食中心", appNameEn:"LYX Food Center",
    lang_zh:"中文", lang_en:"English", lang_vi:"Tiếng Việt",
    orderTitle:"点餐 / Order", cartTitle:"订单 / Cart",
    cat_wonton:"龍兴记ᝰ云吞面", cat_drinks:"饮料", cat_auntie:"婶婶档", cat_gx:"广西卷筒粉",
    subTap:"点击展开/收起", ruleCaption:"规则见小字",
    rule_ice:"全部饮料「冰」另加 RM0.20（罐装水除外）",
    rule_canned:"罐装水统一 RM3.00",
    tableNo:"桌号", takeaway:"外带", dinein:"堂食",
    notes:"备注（例：少甜 / 少冰 / 加辣）",
    add:"加入", plus:"+", minus:"-",
    print:"打印小票", complete_stats_group:"完成并统计（群聊）",
    ordersCount:"订单笔数", itemsSold:"售出件数", salesAmount:"销售金额",
    viewDetail:"查看明细", exportToday:"导出今日 CSV",
    exportWeek:"导出本周 CSV", exportMonth:"导出本月 CSV",
    deleteNeedPwd:"删单（需密码）", password:"密码",
    confirm:"确认", cancel:"取消", ok:"完成", err:"错误",
    delSuccess:"删除成功", delFail:"密码错误，删除失败",
    hot:"（热）", iced:"（冰）",
    toggleBreak:"分类明细", cat:"分类", qty:"数量", amount:"金额", total:"合计"
  },
  en: {
    appName:"LYX Food Center", appNameEn:"LYX Food Center",
    lang_zh:"中文", lang_en:"English", lang_vi:"Tiếng Việt",
    orderTitle:"Order", cartTitle:"Cart",
    cat_wonton:"Long Hing Ji · Wonton Noodles", cat_drinks:"Drinks", cat_auntie:"Auntie's Stall", cat_gx:"Guangxi Rice Rolls",
    subTap:"Tap to toggle", ruleCaption:"See notes",
    rule_ice:"All drinks +RM0.20 for iced (except canned).",
    rule_canned:"Canned drinks RM3.00 flat.",
    tableNo:"Table No.", takeaway:"Takeaway", dinein:"Dine-in",
    notes:"Notes (e.g., less sugar / less ice / extra spicy)",
    add:"Add", plus:"+", minus:"-",
    print:"Print Receipt", complete_stats_group:"Complete & Send (Group)",
    ordersCount:"Orders", itemsSold:"Items Sold", salesAmount:"Sales Amount",
    viewDetail:"View Details", exportToday:"Export Today CSV",
    exportWeek:"Export This Week CSV", exportMonth:"Export This Month CSV",
    deleteNeedPwd:"Delete (password)", password:"Password",
    confirm:"Confirm", cancel:"Cancel", ok:"Done", err:"Error",
    delSuccess:"Deleted", delFail:"Wrong password",
    hot:" (Hot)", iced:" (Iced)",
    toggleBreak:"Breakdown", cat:"Category", qty:"Qty", amount:"Amount", total:"Total"
  },
  vi: {
    appName:"Trung Tâm Ẩm Thực LYX", appNameEn:"LYX Food Center",
    lang_zh:"中文", lang_en:"English", lang_vi:"Tiếng Việt",
    orderTitle:"Gọi món", cartTitle:"Giỏ hàng",
    cat_wonton:"Mì hoành thánh Long Hing Ji", cat_drinks:"Nước uống", cat_auntie:"Gian hàng Cô", cat_gx:"Bánh cuốn Quảng Tây",
    subTap:"Chạm để mở/đóng", ruleCaption:"Xem ghi chú",
    rule_ice:"Mọi thức uống thêm RM0.20 khi đá (trừ đồ lon).",
    rule_canned:"Nước lon đồng giá RM3.00.",
    tableNo:"Số bàn", takeaway:"Mang đi", dinein:"Dùng tại chỗ",
    notes:"Ghi chú (vd: ít đường / ít đá / cay hơn)",
    add:"Thêm", plus:"+", minus:"-",
    print:"In hóa đơn", complete_stats_group:"Hoàn tất & gửi (Nhóm)",
    ordersCount:"Số đơn", itemsSold:"Số món", salesAmount:"Doanh thu",
    viewDetail:"Xem chi tiết", exportToday:"Xuất CSV hôm nay",
    exportWeek:"Xuất CSV tuần này", exportMonth:"Xuất CSV tháng này",
    deleteNeedPwd:"Xóa đơn (mật khẩu)", password:"Mật khẩu",
    confirm:"Xác nhận", cancel:"Hủy", ok:"Hoàn tất", err:"Lỗi",
    delSuccess:"Đã xóa", delFail:"Sai mật khẩu",
    hot:" (Nóng)", iced:" (Đá)",
    toggleBreak:"Chi tiết theo nhóm", cat:"Nhóm", qty:"SL", amount:"Số tiền", total:"Tổng"
  }
};
let currentLang = localStorage.getItem("lyx_lang") || "zh";
function t(k){ return (i18n[currentLang]||i18n.zh)[k] ?? k; }
function applyLang(lang){
  currentLang = ["zh","en","vi"].includes(lang)?lang:"zh";
  localStorage.setItem("lyx_lang", currentLang);
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k=el.getAttribute("data-i18n");
    if(el.dataset.i18nTarget==="placeholder"){ el.placeholder=t(k); }
    else{ el.textContent=t(k); }
  });
  document.getElementById('btn-zh').classList.toggle('active',currentLang==="zh");
  document.getElementById('btn-en').classList.toggle('active',currentLang==="en");
  document.getElementById('btn-vi').classList.toggle('active',currentLang==="vi");
  renderAll();
}

/* ============ 菜单数据（含分类） ============ */
const CAT = {
  wonton: 'wonton',
  drinks: 'drinks',
  auntie: 'auntie',
  gx: 'gx'
};

/* —— 龍兴记ᝰ云吞面 —— */
const WONTON = [
  {id:"w_noodle_s",  name_zh:"云吞面（小）", name_en:"Wonton Noodle (S)", name_vi:"Mì hoành thánh (S)", price:6.50, cat:CAT.wonton},
  {id:"w_noodle_m",  name_zh:"云吞面（中）", name_en:"Wonton Noodle (M)", name_vi:"Mì hoành thánh (M)", price:7.50, cat:CAT.wonton},
  {id:"w_noodle_l",  name_zh:"云吞面（大）", name_en:"Wonton Noodle (L)", name_vi:"Mì hoành thánh (L)", price:8.50, cat:CAT.wonton},
  {id:"w_wantan_dry", name_zh:"云吞 干捞（一份）", name_en:"Wantan Dry (1 portion)", name_vi:"Hoành thánh khô (1 phần)", price:5.00, cat:CAT.wonton},
  {id:"w_wantan_soup",name_zh:"云吞 汤（一份）", name_en:"Wantan Soup (1 portion)", name_vi:"Hoành thánh nước (1 phần)", price:5.00, cat:CAT.wonton},
  {id:"w_addon_3",    name_zh:"加料：云吞 ×3", name_en:"Add-on: 3 Wantans", name_vi:"Thêm: 3 hoành thánh", price:1.00, cat:CAT.wonton}
];

/* —— 饮料 ——（热/冰价；罐装固定） */
const DRINKS = [
  {id:"d_coffee",     base:"咖啡",     hot:2.30, iced:2.50},
  {id:"d_coffee_c",   base:"咖啡C",    hot:2.50, iced:2.70},
  {id:"d_coffee_o",   base:"咖啡O",    hot:2.00, iced:2.20},
  {id:"d_milktea",    base:"奶茶",     hot:2.30, iced:2.50},
  {id:"d_milktea_c",  base:"奶茶C",    hot:2.50, iced:2.70},
  {id:"d_milktea_sc", base:"奶茶咸C",  hot:2.50, iced:2.70},
  {id:"d_milo",       base:"Milo",     hot:2.60, iced:2.80},
  {id:"d_milo_c",     base:"Milo C",   hot:2.80, iced:3.00},
  {id:"d_milo_o",     base:"Milo O",   hot:2.60, iced:2.80},
];
const CANNED = {id:"d_canned", name_zh:"罐装水", name_en:"Canned Drinks", name_vi:"Nước lon", price:3.00, cat:CAT.drinks};

/* —— 婶婶档 —— */
const AUNTIE = [
  {id:"a_bitter_rice_noodle", name_zh:"苦瓜米粉", name_en:"Bitter Gourd Rice Vermicelli", name_vi:"Bún gạo khổ qua", price:6.00, cat:CAT.auntie},
  {id:"a_nasi_ayam",          name_zh:"Nasi Lemak（有鸡肉）", name_en:"Nasi Lemak (Chicken)", name_vi:"Nasi Lemak (gà)", price:6.00, cat:CAT.auntie},
  {id:"a_nasi_egg",           name_zh:"Nasi Lemak（只有鸡蛋）", name_en:"Nasi Lemak (Egg only)", name_vi:"Nasi Lemak (trứng)", price:3.00, cat:CAT.auntie},
  {id:"a_mian_fen_gao",       name_zh:"面粉糕", name_en:"Pan Mee", name_vi:"Bánh bột mì", price:6.00, cat:CAT.auntie},
  {id:"a_hongshao_fan",       name_zh:"红烧饭", name_en:"Braised Pork Rice", name_vi:"Cơm thịt kho", price:6.00, cat:CAT.auntie},
  {id:"a_congee_pork",        name_zh:"鱼粥（猪肉）", name_en:"Fish Congee (Pork)", name_vi:"Cháo cá (thịt heo)", price:6.00, cat:CAT.auntie},
  {id:"a_congee_chicken",     name_zh:"鱼粥（鸡肉）", name_en:"Fish Congee (Chicken)", name_vi:"Cháo cá (gà)", price:6.00, cat:CAT.auntie},
  {id:"a_mianxian",           name_zh:"面线", name_en:"Mee Sua", name_vi:"Mì sợi mảnh", price:6.00, cat:CAT.auntie},
  {id:"a_lu_rou_fan",         name_zh:"卤肉饭（配卤蛋）", name_en:"Lu Rou Fan (+egg)", name_vi:"Cơm thịt kho (kèm trứng)", price:6.00, cat:CAT.auntie},
  {id:"a_kuey_teow_soup",     name_zh:"果条汤", name_en:"Kuey Teow Soup", name_vi:"Hủ tiếu nước", price:6.00, cat:CAT.auntie}
];

/* —— 广西卷筒粉 —— */
const GX = [
  {id:"g_kosong", name_zh:"素粉 (kosong)", name_en:"Plain Roll",  name_vi:"Bánh cuốn chay", price:1.00, cat:CAT.gx},
  {id:"g_veg",    name_zh:"蔬菜卷筒粉",     name_en:"Veg Roll",    name_vi:"Bánh cuốn rau",  price:2.00, cat:CAT.gx},
  {id:"g_mix",    name_zh:"菜加肉卷筒粉",   name_en:"Veg+Meat Roll",name_vi:"Rau + thịt",   price:3.00, cat:CAT.gx},
  {id:"g_meat",   name_zh:"肉卷筒粉",       name_en:"Meat Roll",   name_vi:"Bánh cuốn thịt",price:3.00, cat:CAT.gx},
  {id:"g_family", name_zh:"全家福卷筒粉",   name_en:"Mixed Family", name_vi:"Thập cẩm",     price:4.00, cat:CAT.gx},
  {id:"g_spring", name_zh:"春卷",           name_en:"Spring Roll",  name_vi:"Chả giò",      price:1.00, cat:CAT.gx},
  {id:"g_yutou",  name_zh:"芋头米糕",       name_en:"Taro Cake",    name_vi:"Bánh khoai môn",price:1.00, cat:CAT.gx}
];

/* ============ 渲染与购物车 ============ */
function displayName(it){
  if(!it) return "";
  if(currentLang==="en") return it.name_en || it.name_zh || it.base;
  if(currentLang==="vi") return it.name_vi || it.name_zh || it.base;
  return it.name_zh || it.base;
}

const cart = {items:{}}; // {id: qty}
const ALL = [...WONTON, ...AUNTIE, ...GX]; // 固定价类

function inc(id){ cart.items[id]=(cart.items[id]||0)+1; renderCart(); syncQty(id); }
function dec(id){ if(!cart.items[id]) return; cart.items[id]--; if(cart.items[id]<=0) delete cart.items[id]; renderCart(); syncQty(id); }

function itemCard(it, price){
  const title = displayName(it)+(price!=null?` — RM ${price.toFixed(2)}`:"");
  const id = price!=null?`${it.id}_${price.toFixed(2)}`:it.id;
  return `
  <div class="item">
    <div class="left">
      <div class="title">${title}</div>
      ${it.unit?`<div class="sub">${it.unit}</div>`:""}
    </div>
    <div>
      <button class="btn small" onclick="dec('${id}')" aria-label="minus">−</button>
      <div id="qty-${id}" class="qty">${cart.items[id]||0}</div>
      <button class="btn small" onclick="inc('${id}')" aria-label="plus">+</button><br>
      <button class="btn add" onclick="inc('${id}')" data-i18n="add">${t('add')}</button>
    </div>
  </div>`;
}

function renderCategory(elId, list, isDrink=false){
  const el=document.getElementById(elId);
  let html="";
  list.forEach(it=>{
    if(isDrink){
      if(it.hot)  html+=itemCard({id:it.id+"_hot", name_zh:it.base+"（热）", name_en:it.base+t('hot'), name_vi:it.base+t('hot'), cat:CAT.drinks}, it.hot);
      if(it.iced) html+=itemCard({id:it.id+"_ice", name_zh:it.base+"（冰）",  name_en:it.base+t('iced'), name_vi:it.base+t('iced'), cat:CAT.drinks}, it.iced);
    }else{
      html+=itemCard(it, it.price);
    }
  });
  if(elId==="cat-drinks"){
    html+=itemCard(CANNED, CANNED.price);
  }
  el.innerHTML=html;
}

function renderAll(){
  renderCategory('cat-wonton', WONTON);
  renderCategory('cat-drinks', DRINKS, true);
  renderCategory('cat-auntie', AUNTIE);
  renderCategory('cat-gx', GX);
  renderCart();
}

function priceOf(id){
  const m=id.match(/_(\d+\.\d{2})$/);
  if(m) return parseFloat(m[1]);          // 饮料温度价已在 id
  const f=ALL.find(x=>x.id===id) || (CANNED.id===id?CANNED:null);
  return f?f.price:0;
}

function catOf(id){
  // 饮料：id 形如 d_xxx_hot_2.50
  if(id.startsWith('d_')) return CAT.drinks;
  const pure=id.replace(/_\d+\.\d{2}$/,'');
  const f=ALL.find(x=>x.id===pure) || (pure===CANNED.id?CANNED:null);
  return f?f.cat:CAT.wonton;
}

function nameOf(id){
  const baseId=id.replace(/_\d+\.\d{2}$/,'');
  if(baseId.startsWith("d_")){
    const isHot=id.includes("_hot");
    const isIce=id.includes("_ice");
    if(baseId==="d_canned") return displayName(CANNED);
    const base=DRINKS.find(x=> baseId.startsWith(x.id));
    const nm= base? base.base : baseId;
    if(isHot) return nm + (currentLang==="zh"?"（热）": currentLang==="en"? " (Hot)":" (Nóng)");
    if(isIce) return nm + (currentLang==="zh"?"（冰）": currentLang==="en"? " (Iced)":" (Đá)");
    return nm;
  }
  const f=ALL.find(x=> x.id===baseId) || (baseId===CANNED.id?CANNED:null);
  return displayName(f||{name_zh:id});
}

function syncQty(id){
  const q=document.getElementById('qty-'+id);
  if(q) q.textContent=cart.items[id]||0;
}

function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }

function renderCart(){
  const c=document.getElementById('cart'); c.innerHTML="";
  let subtotal=0, items=0;
  Object.keys(cart.items).forEach(id=>{
    const qty=cart.items[id];
    const line=priceOf(id)*qty; subtotal+=line; items+=qty;
    const row=document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="left"><div class="title">${nameOf(id)} × ${qty}</div></div>
      <div style="text-align:right">
        <div style="font-weight:900">RM ${fmt(line)}</div>
        <div style="margin-top:6px">
          <button class="btn small" onclick="inc('${id}')">+</button>
          <button class="btn small" onclick="dec('${id}')">−</button>
        </div>
      </div>`;
    c.appendChild(row);
  });
  const sum=document.createElement('div'); sum.className='sum';
  sum.innerHTML = `<div style="font-weight:900">合计 Total: RM ${fmt(subtotal)}</div>`;
  c.appendChild(sum);
}

/* ============ 统计存储（按天） ============ */
function todayKey(){ const d=new Date(); return "lyx_stats_"+d.toISOString().slice(0,10); }
function loadStats(){
  const raw=localStorage.getItem(todayKey());
  return raw? JSON.parse(raw): {orders:0, items:0, sales:0, list:[], cat:{wonton:{q:0,a:0}, drinks:{q:0,a:0}, auntie:{q:0,a:0}, gx:{q:0,a:0}}};
}
function saveStats(st){ localStorage.setItem(todayKey(), JSON.stringify(st)); showKpis(); }
function showKpis(){
  const st=loadStats();
  document.getElementById('kpi-orders').textContent=st.orders;
  document.getElementById('kpi-items').textContent=st.items;
  document.getElementById('kpi-sales').textContent="RM "+fmt(st.sales);
}

/* 分类明细渲染 */
function renderBreakdown(){
  const st=loadStats();
  const map=st.cat||{};
  const rows=[
    {k:CAT.wonton, label:t('cat_wonton')},
    {k:CAT.drinks, label:t('cat_drinks')},
    {k:CAT.auntie, label:t('cat_auntie')},
    {k:CAT.gx,     label:t('cat_gx')}
  ];
  const tbody=document.getElementById('bd-body'); tbody.innerHTML="";
  let tq=0, ta=0;
  rows.forEach(r=>{
    const q=(map[r.k]?.q)||0, a=(map[r.k]?.a)||0;
    tq+=q; ta+=a;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.label}</td><td>${q}</td><td>RM ${fmt(a)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('bd-q').textContent=tq;
  document.getElementById('bd-a').textContent="RM "+fmt(ta);
}
function toggleBreakdown(){
  const box=document.getElementById('breakdown');
  box.classList.toggle('hidden');
  if(!box.classList.contains('hidden')) renderBreakdown();
}

/* ============ 完成 & WhatsApp 群发（号码） ============ */
const WA_LIST = ["60122847784","601161379373","60187794329","60187890583","60182925799"];

function finishAndSend(){
  if(Object.keys(cart.items).length===0){ alert('请先选择项目 / Please add items first'); return; }
  const table = document.getElementById('tableNo').value || "-";
  const type  = document.getElementById('takeaway').checked ? t('takeaway') : t('dinein');
  const note  = (document.getElementById('note').value||"").trim();
  let subtotal=0, lines=[], items=0;

  // 分类累计
  const st=loadStats();
  const catAgg=st.cat || (st.cat={wonton:{q:0,a:0},drinks:{q:0,a:0},auntie:{q:0,a:0},gx:{q:0,a:0}});

  Object.keys(cart.items).forEach(id=>{
    const qty=cart.items[id]; items+=qty;
    const price=priceOf(id), line=price*qty; subtotal+=line;
    lines.push(`- ${nameOf(id)} × ${qty} = RM ${fmt(line)}`);
    const ck=catOf(id); catAgg[ck].q+=qty; catAgg[ck].a+=line;   // 分类计数
  });

  // 入库
  st.orders+=1; st.items+=items; st.sales+=subtotal;
  st.list.push({time:new Date().toLocaleString(), table, takeaway:type, lines, total:subtotal, note});
  saveStats(st);

  // WhatsApp 群发（依次打开）
  const NL="%0A";
  const title = `【${t('appName')}】订单 / Order`;
  const msg = [
    title, `桌号 Table: ${table}`, `类型 Type: ${type}`,'', '明细 / Items:'
  ].concat(lines).concat(['',`合计 Total: RM ${fmt(subtotal)}`, note?('备注 Notes: '+encodeURIComponent(note)):""]).join(NL);
  WA_LIST.forEach((phone,i)=> setTimeout(()=>window.open(`https://wa.me/${phone}?text=${msg}`,'_blank'), i*400));

  // 清空购物车（历史与统计保留）
  cart.items={};
  renderCart(); showKpis(); renderBreakdown();
}

/* ============ 打印小票 ============ */
function printReceipt(){
  if(Object.keys(cart.items).length===0){ alert('没有项目 / No items'); return; }
  const area=document.getElementById('print-area'); area.classList.remove('hidden');
  const table=document.getElementById('tableNo').value || '-';
  const type=document.getElementById('takeaway').checked ? t('takeaway') : t('dinein');
  let subtotal=0, body='';
  Object.keys(cart.items).forEach(id=>{
    const qty=cart.items[id]; const line=priceOf(id)*qty; subtotal+=line;
    body+=`<div>${nameOf(id)} × ${qty}<span style="float:right">RM ${fmt(line)}</span></div>`;
  });
  area.innerHTML = `
  <div style="max-width:340px;margin:0 auto;font-size:13px;line-height:1.35">
    <div style="text-align:center;font-weight:900">${t('appName')}<br><small>${t('appNameEn')}</small></div>
    <div>时间 Time: ${new Date().toLocaleString()}</div>
    <div>桌号 Table: ${table}</div>
    <div>类型 Type: ${type}</div>
    <hr>${body}<hr>
    <div style="font-weight:900">合计 Total: RM ${fmt(subtotal)}</div>
    <div style="text-align:center;margin-top:8px">谢谢惠顾，欢迎再次光临！<br><small>Thank you, please come again!</small></div>
  </div>`;
  window.print(); area.classList.add('hidden');
}

/* ============ 导出/查看/删除 ============ */
function csvEscape(s){ return `"${String(s).replace(/"/g,'""')}"`; }

function exportCSV(scope){
  const now=new Date();
  const keys=[];
  for(let i=0;i<40;i++){
    const d=new Date(now);
    if(scope==="today"){ /* 仅今天 */ }
    else d.setDate(now.getDate()-i);
    const k="lyx_stats_"+d.toISOString().slice(0,10);
    const v=localStorage.getItem(k); if(v) keys.push(k);
    if(scope==="today") break;
    if(scope==="week" && d.getDay()===0 && i>0) break;
    if(scope==="month"&& d.getDate()===1 && i>0) break;
  }
  const rows=[["date","time","table","type","item_lines","total","wonton_q","wonton_a","drinks_q","drinks_a","auntie_q","auntie_a","gx_q","gx_a"].map(csvEscape).join(",")];
  keys.reverse().forEach(k=>{
    const day=k.slice(-10), st=JSON.parse(localStorage.getItem(k)||"{}");
    const c=st.cat||{};
    (st.list||[]).forEach(r=>{
      rows.push([day,r.time,r.table,r.takeaway,(r.lines||[]).join(" | "),"RM "+fmt(r.total),
        c.wonton?.q||0,fmt(c.wonton?.a||0),
        c.drinks?.q||0,fmt(c.drinks?.a||0),
        c.auntie?.q||0,fmt(c.auntie?.a||0),
        c.gx?.q||0,fmt(c.gx?.a||0)
      ].map(csvEscape).join(","));
    });
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`lyx_${scope}_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}

function viewToday(){
  const st=loadStats(); const lines=(st.list||[]).map((r,i)=>`${i+1}. [${r.time}] ${r.table}/${r.takeaway}\n   ${r.lines.join("\n   ")}\n   Total: RM ${fmt(r.total)}${r.note?("\n   Note: "+r.note):""}`).join("\n\n");
  alert((lines||"（暂无）") + `\n\nOrders: ${st.orders} | Items: ${st.items} | Sales: RM ${fmt(st.sales)}`);
}

const DELETE_PWD = "Lyx115599$";
function deleteWithPwd(){
  const p=prompt(t('password')+" / Password");
  if(p!==DELETE_PWD){ alert(t('delFail')); return; }
  localStorage.removeItem(todayKey());
  alert(t('delSuccess'));
  showKpis(); renderBreakdown();
}

/* ============ 启动：强制所有分页默认收起 + 渲染 ============ */
document.addEventListener('DOMContentLoaded', ()=>{
  // 关键：默认全部折叠
  document.querySelectorAll('details').forEach(d=>d.removeAttribute('open'));

  applyLang(currentLang);   // 同时会 renderAll()
  showKpis();
  renderBreakdown();
});
</script>
</body>
</html>
