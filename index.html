<!DOCTYPE html>
<html lang="zh" translate="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>龍運轩ᝰ美食中心 · LYX Food Center</title>
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#f7f8fb;--card:#fff;--ink:#0f172a;--mut:#6b7280;--line:#e5e7eb;--brand:#0ea5e9;--ok:#059669;--accent:#f59e0b;--shadow:0 8px 24px rgba(2,8,23,.06)}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{text-decoration:none;color:inherit}
.wrap{max-width:1200px;margin:20px auto;padding:0 12px 24px}
header{position:sticky;top:0;z-index:9;background:linear-gradient(180deg,#0ea5e9,#0284c7);color:#fff;padding:14px 16px}
h1{margin:0;font-size:20px;letter-spacing:.5px;display:flex;gap:10px;align-items:baseline}
h1 small{opacity:.9}
.lang{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.lang button{padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.45);background:rgba(255,255,255,.12);color:#fff;cursor:pointer;font-weight:700}
.lang button.active{background:#fff;color:#0b3a55}

.grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.panel{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
.panel h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px;display:flex;align-items:center;gap:8px}
.section{padding:12px 12px 18px}

.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin:0 6px 10px}
.label{font-weight:700}
.input{padding:10px;border:1px solid var(--line);border-radius:12px;min-width:140px}
.switch{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px 10px;background:#fff}

details{border:1px solid var(--line);border-radius:14px;margin:10px 0;background:#fff}
summary{list-style:none;cursor:pointer;padding:12px 14px;border-radius:14px;display:flex;justify-content:space-between;align-items:center;font-weight:900;background:#fff7ed;border-left:4px solid var(--accent)}
summary::marker,summary::-webkit-details-marker{display:none}
.cat-sub{color:#a16207;font-weight:600;font-size:12px}

.cards{padding:10px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media (max-width:720px){.cards{grid-template-columns:1fr}}
.item{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;display:flex;gap:12px;align-items:center}
.item .left{flex:1}
.title{font-weight:900}
.sub{color:var(--mut);font-size:12px;line-height:1.25}
.qty{min-width:64px;text-align:center;font-weight:900;font-size:18px}

.btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer}
.btn.small{padding:14px 18px;font-size:22px;border-width:2px}
.btn.add{background:var(--brand);border-color:var(--brand);color:#fff;font-weight:800}

.sticky{position:sticky;top:86px}
.sumrow{display:flex;gap:10px;margin-top:10px}
.sumrow .btn.print{flex:1;background:#1d4ed8;border-color:#1d4ed8;color:#fff}
.sumrow .btn.done{flex:3;background:var(--ok);border-color:var(--ok);color:#fff}
.note{width:100%;min-height:68px;border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px}
.sum{border-top:1px dashed var(--line);padding-top:10px;margin-top:10px}

.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
.kpi{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;text-align:center}
.kpi b{display:block;font-size:18px}

.tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.hidden{display:none}
</style>
</head>
<body>
<header>
  <h1><span data-i18n="appName">龍運轩ᝰ美食中心</span> <small data-i18n="appNameEn">LYX Food Center</small></h1>
  <div class="lang">
    <button id="btn-zh" class="active" onclick="applyLang('zh')" data-i18n="lang_zh">中文</button>
    <button id="btn-en" onclick="applyLang('en')" data-i18n="lang_en">English</button>
    <button id="btn-vi" onclick="applyLang('vi')" data-i18n="lang_vi">Tiếng Việt</button>
  </div>
</header>

<div class="wrap grid">
  <!-- 左：菜单 -->
  <section class="panel">
    <h3 data-i18n="orderTitle">点餐 / Order</h3>
    <div class="section">
      <div class="controls">
        <label class="label" data-i18n="tableNo">桌号</label>
        <input id="tableNo" class="input" placeholder="A1">
        <label class="switch">
          <input type="checkbox" id="takeaway">
          <span data-i18n="takeaway">外带</span>
        </label>
      </div>

      <!-- 龍兴记ᝰ云吞面 -->
      <details>
        <summary>
          <span data-i18n="cat_wonton">龍兴记ᝰ云吞面</span>
          <span class="cat-sub" data-i18n="subTap">点击展开/收起</span>
        </summary>
        <div class="cards" id="cat-wonton"></div>
      </details>

      <!-- 饮料 -->
      <details>
        <summary>
          <span data-i18n="cat_drinks">饮料</span>
          <span class="cat-sub" data-i18n="ruleCaption">规则见小字</span>
        </summary>
        <div class="section" style="padding:10px 14px">
          <div class="sub" data-i18n="rule_ice">全部饮料「冰」另加 RM0.20（罐装水除外）</div>
          <div class="sub" data-i18n="rule_canned">罐装水统一 RM3.00</div>
        </div>
        <div class="cards" id="cat-drinks"></div>
      </details>

      <!-- 婶婶档 -->
      <details>
        <summary>
          <span data-i18n="cat_auntie">婶婶档</span>
          <span class="cat-sub" data-i18n="subTap">点击展开/收起</span>
        </summary>
        <div class="cards" id="cat-auntie"></div>
      </details>

      <!-- 广西卷筒粉 -->
      <details>
        <summary>
          <span data-i18n="cat_gx">广西卷筒粉</span>
          <span class="cat-sub" data-i18n="subTap">点击展开/收起</span>
        </summary>
        <div class="cards" id="cat-gx"></div>
      </details>
    </div>
  </section>

  <!-- 右：订单 -->
  <aside class="panel sticky">
    <h3 data-i18n="cartTitle">订单 / Cart</h3>
    <div id="cart" class="section"></div>
    <div class="section">
      <label class="label" data-i18n="notes">备注（例：少甜 / 少冰 / 加辣）</label>
      <textarea id="note" class="note" placeholder=""></textarea>
      <div class="sumrow">
        <button class="btn print" onclick="printReceipt()" data-i18n="print">打印小票</button>
        <button class="btn done" onclick="finishAndSend()" data-i18n="complete_stats_group">完成并统计（群聊）</button>
      </div>

      <div class="kpis">
        <div class="kpi"><span data-i18n="ordersCount">订单笔数</span><b id="kpi-orders">0</b></div>
        <div class="kpi"><span data-i18n="itemsSold">售出件数</span><b id="kpi-items">0</b></div>
        <div class="kpi"><span data-i18n="salesAmount">销售金额</span><b id="kpi-sales">RM 0.00</b></div>
      </div>

      <!-- 分类统计 -->
      <details class="section" style="margin:10px 12px 0;border:1px solid var(--line);border-radius:12px">
        <summary style="padding:10px 12px;font-weight:900;cursor:pointer" data-i18n="breakdownTitle">分类统计 · Breakdown</summary>
        <div id="breakdown" style="padding:10px 12px">
          <div class="sub" data-i18n="breakdownHint">下单后这里会显示今天各分类的【数量 / 金额】汇总。</div>
        </div>
        <div style="padding:0 12px 12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="exportBreakdownCSV()" data-i18n="exportBreakdown">导出分类 CSV</button>
        </div>
      </details>

      <div class="tools">
        <button class="btn" onclick="viewToday()" data-i18n="viewDetail">查看明细</button>
        <button class="btn" onclick="exportCSV('today')" data-i18n="exportToday">导出今日 CSV</button>
        <button class="btn" onclick="exportCSV('week')" data-i18n="exportWeek">导出本周 CSV</button>
        <button class="btn" onclick="exportCSV('month')" data-i18n="exportMonth">导出本月 CSV</button>
        <button class="btn" onclick="deleteWithPwd()" data-i18n="deleteNeedPwd">删单（需密码）</button>
      </div>
    </div>
  </aside>
</div>

<!-- 打印区 -->
<div id="print-area" class="hidden"></div>

<script>
/* ============ 多语言 ============ */
const i18n = {
  zh:{appName:"龍運轩ᝰ美食中心",appNameEn:"LYX Food Center",
      lang_zh:"中文",lang_en:"English",lang_vi:"Tiếng Việt",
      orderTitle:"点餐 / Order",cartTitle:"订单 / Cart",
      cat_wonton:"龍兴记ᝰ云吞面",cat_drinks:"饮料",cat_auntie:"婶婶档",cat_gx:"广西卷筒粉",
      subTap:"点击展开/收起",ruleCaption:"规则见小字",
      rule_ice:"全部饮料「冰」另加 RM0.20（罐装水除外）",rule_canned:"罐装水统一 RM3.00",
      tableNo:"桌号",takeaway:"外带",dinein:"堂食",
      notes:"备注（例：少甜 / 少冰 / 加辣）",
      add:"加入",plus:"+",minus:"-",
      print:"打印小票",complete_stats_group:"完成并统计（群聊）",
      ordersCount:"订单笔数",itemsSold:"售出件数",salesAmount:"销售金额",
      viewDetail:"查看明细",exportToday:"导出今日 CSV",exportWeek:"导出本周 CSV",exportMonth:"导出本月 CSV",
      deleteNeedPwd:"删单（需密码）",password:"密码",confirm:"确认",cancel:"取消",ok:"完成",err:"错误",
      delSuccess:"删除成功",delFail:"密码错误，删除失败",hot:"（热）",iced:"（冰）",
      breakdownTitle:"分类统计 · Breakdown",breakdownHint:"下单后这里会显示今天各分类的【数量 / 金额】汇总。",exportBreakdown:"导出分类 CSV"},
  en:{appName:"LYX Food Center",appNameEn:"LYX Food Center",
      lang_zh:"中文",lang_en:"English",lang_vi:"Tiếng Việt",
      orderTitle:"Order",cartTitle:"Cart",
      cat_wonton:"Wonton Noodles",cat_drinks:"Drinks",cat_auntie:"Auntie's Stall",cat_gx:"Guangxi Rice Rolls",
      subTap:"Tap to toggle",ruleCaption:"See notes",
      rule_ice:"Iced +RM0.20 (except canned).",rule_canned:"Canned drinks RM3.00.",
      tableNo:"Table No.",takeaway:"Takeaway",dinein:"Dine-in",
      notes:"Notes (e.g., less sugar / less ice / extra spicy)",
      add:"Add",plus:"+",minus:"-",
      print:"Print Receipt",complete_stats_group:"Complete & Send (Group)",
      ordersCount:"Orders",itemsSold:"Items Sold",salesAmount:"Sales Amount",
      viewDetail:"View Details",exportToday:"Export Today CSV",exportWeek:"Export This Week CSV",exportMonth:"Export This Month CSV",
      deleteNeedPwd:"Delete (password)",password:"Password",confirm:"Confirm",cancel:"Cancel",ok:"Done",err:"Error",
      delSuccess:"Deleted",delFail:"Wrong password",hot:" (Hot)",iced:" (Iced)",
      breakdownTitle:"Breakdown",breakdownHint:"After checkout, see today's quantities & amounts by category here.",exportBreakdown:"Export Breakdown CSV"},
  vi:{appName:"Trung Tâm Ẩm Thực LYX",appNameEn:"LYX Food Center",
      lang_zh:"中文",lang_en:"English",lang_vi:"Tiếng Việt",
      orderTitle:"Gọi món",cartTitle:"Giỏ hàng",
      cat_wonton:"Mì hoành thánh",cat_drinks:"Nước uống",cat_auntie:"Gian hàng Cô",cat_gx:"Bánh cuốn Quảng Tây",
      subTap:"Chạm để mở/đóng",ruleCaption:"Xem ghi chú",
      rule_ice:"Đá +RM0.20 (trừ đồ lon).",rule_canned:"Nước lon RM3.00.",
      tableNo:"Số bàn",takeaway:"Mang đi",dinein:"Dùng tại chỗ",
      notes:"Ghi chú (vd: ít đường / ít đá / cay hơn)",
      add:"Thêm",plus:"+",minus:"-",
      print:"In hóa đơn",complete_stats_group:"Hoàn tất & Gửi (Nhóm)",
      ordersCount:"Số đơn",itemsSold:"Số món",salesAmount:"Doanh thu",
      viewDetail:"Xem chi tiết",exportToday:"Xuất CSV hôm nay",exportWeek:"Xuất CSV tuần này",exportMonth:"Xuất CSV tháng này",
      deleteNeedPwd:"Xóa đơn (mật khẩu)",password:"Mật khẩu",confirm:"Xác nhận",cancel:"Hủy",ok:"Hoàn tất",err:"Lỗi",
      delSuccess:"Đã xóa",delFail:"Sai mật khẩu",hot:" (Nóng)",iced:" (Đá)",
      breakdownTitle:"Thống kê",breakdownHint:"Sau khi thanh toán, xem số lượng & doanh thu theo nhóm tại đây.",exportBreakdown:"Xuất CSV thống kê"}
};
let currentLang = localStorage.getItem("lyx_lang") || "zh";
function t(k){ return (i18n[currentLang]||i18n.zh)[k] ?? k; }
function applyLang(lang){
  currentLang = ["zh","en","vi"].includes(lang)?lang:"zh";
  localStorage.setItem("lyx_lang", currentLang);
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k=el.getAttribute("data-i18n");
    if(el.dataset.i18nTarget==="placeholder"){ el.placeholder=t(k); }
    else{ el.textContent=t(k); }
  });
  document.getElementById('btn-zh').classList.toggle('active',currentLang==="zh");
  document.getElementById('btn-en').classList.toggle('active',currentLang==="en");
  document.getElementById('btn-vi').classList.toggle('active',currentLang==="vi");
  renderAll();
}

/* ============ 菜单数据（按你的清单） ============ */
/* 1) 龍兴记ᝰ云吞面 */
const WONTON = [
  {id:"w_noodle_S", name_zh:"云吞面（小）", name_en:"Wonton Noodle (S)", name_vi:"Mì hoành thánh (nhỏ)", price:6.50},
  {id:"w_noodle_M", name_zh:"云吞面（中）", name_en:"Wonton Noodle (M)", name_vi:"Mì hoành thánh (vừa)", price:7.50},
  {id:"w_noodle_L", name_zh:"云吞面（大）", name_en:"Wonton Noodle (L)", name_vi:"Mì hoành thánh (lớn)", price:8.50},
  {id:"w_wantan_dry",  name_zh:"云吞 干捞（一份）", name_en:"Wantan (Dry, 1 portion)",  name_vi:"Hoành thánh khô (1 phần)",  price:5.00},
  {id:"w_wantan_soup", name_zh:"云吞 汤（一份）",   name_en:"Wantan Soup (1 portion)", name_vi:"Hoành thánh nước (1 phần)", price:5.00},
  {id:"w_addon_3",     name_zh:"加料：云吞 ×3",     name_en:"Add-on: 3 Wantans",      name_vi:"Thêm: 3 hoành thánh",     price:1.00}
];

/* 2) 饮料——按规则：冰 = 热 + 0.20；罐装水固定 3.00 */
const DRINK_BASE = [
  {key:"咖啡",    hot:2.30},
  {key:"咖啡C",   hot:2.50},
  {key:"咖啡O",   hot:2.00},
  {key:"奶茶",    hot:2.30},
  {key:"奶茶C",   hot:2.50},
  {key:"奶茶咸C", hot:2.50},
  {key:"Milo",    hot:2.60},
  {key:"Milo C",  hot:2.80},
  {key:"Milo O",  hot:2.60},
];
const DRINKS = [];
DRINK_BASE.forEach(d=>{
  DRINKS.push({id:slug(d.key)+"_hot_"+(d.hot).toFixed(2), base:d.key, temp:"hot",  price:d.hot});
  DRINKS.push({id:slug(d.key)+"_ice_"+(d.hot+0.20).toFixed(2), base:d.key, temp:"ice", price:(d.hot+0.20)});
});
const CANNED = {id:"canned_3.00", name_zh:"罐装水", name_en:"Canned Drinks", name_vi:"Nước lon", price:3.00};

/* 3) 婶婶档 */
const AUNTIE = [
  {id:"a_fish_congee",  name_zh:"鱼粥",               name_en:"Fish Congee",            name_vi:"Cháo cá",          price:6.00},
  {id:"a_chicken_congee",name_zh:"鸡肉粥",            name_en:"Chicken Congee",         name_vi:"Cháo gà",          price:6.00},
  {id:"a_pork_congee",  name_zh:"猪肉粥",             name_en:"Pork Congee",            name_vi:"Cháo heo",         price:6.00},
  {id:"a_laksa_chicken",name_zh:"鸡肉拉沙（Laksa）",   name_en:"Laksa (Chicken)",        name_vi:"Laksa gà",         price:6.00},
  {id:"a_laksa_plain",  name_zh:"拉沙（Laksa）",       name_en:"Laksa (Plain)",          name_vi:"Laksa thường",     price:3.00},
  {id:"a_rice_vermicelli",name_zh:"米粉",             name_en:"Rice Vermicelli",        name_vi:"Bún gạo",          price:6.00},
  {id:"a_roast_chicken",name_zh:"烤鸡 / 烧烤鸡",        name_en:"Roasted/BBQ Chicken",    name_vi:"Gà nướng",         price:6.00},
  {id:"a_rice_noodle",  name_zh:"米线",               name_en:"Rice Noodle",            name_vi:"Bún",              price:6.00},
  {id:"a_lu_rou_fan",   name_zh:"卤肉饭（配卤蛋）",    name_en:"Lu Rou Fan (with egg)",  name_vi:"Cơm thịt kho + trứng", price:6.00},
  {id:"a_bitter_rice",  name_zh:"苦瓜米粉",            name_en:"Bitter Gourd Vermicelli",name_vi:"Bún khổ qua",      price:6.00}
];

/* 4) 广西卷筒粉 */
const GX = [
  {id:"gx_kosong",  name_zh:"素粉（kosong）", name_en:"Plain Rice Roll (kosong)", name_vi:"Bánh cuốn chay", price:1.00},
  {id:"gx_veg",     name_zh:"蔬菜卷筒粉",     name_en:"Veg Rice Roll",            name_vi:"Bánh cuốn rau",  price:2.00},
  {id:"gx_mix",     name_zh:"菜加肉卷筒粉",   name_en:"Meat+Veg Rice Roll",       name_vi:"Bánh cuốn thịt+rau", price:3.00},
  {id:"gx_meat",    name_zh:"肉卷筒粉",       name_en:"Meat Rice Roll",           name_vi:"Bánh cuốn thịt", price:3.00},
  {id:"gx_family",  name_zh:"全家福卷筒粉",   name_en:"Assorted Rice Roll",       name_vi:"Bánh cuốn thập cẩm", price:4.00},
  {id:"gx_spring",  name_zh:"春卷",           name_en:"Spring Roll",              name_vi:"Chả giò",        price:1.00},
  {id:"gx_taro",    name_zh:"芋头米糕",       name_en:"Taro Rice Cake",           name_vi:"Bánh gạo khoai môn", price:1.00}
];

/* ============ 购物车与渲染 ============ */
const cart={items:{}}; // {id: qty}
function slug(s){return s.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]+/g,'');}
function displayName(it){
  if(!it) return "";
  if(currentLang==="en") return it.name_en || it.base || it.name_zh;
  if(currentLang==="vi") return it.name_vi || it.base || it.name_zh;
  return it.name_zh || it.base;
}
function itemCard(it, priceOverride){
  const price = priceOverride!=null ? priceOverride : it.price;
  const id = priceOverride!=null ? `${it.id}_${price.toFixed(2)}` : it.id;
  return `
  <div class="item">
    <div class="left">
      <div class="title">${displayName(it)}</div>
      <div class="sub">RM ${price.toFixed(2)}</div>
    </div>
    <div>
      <button class="btn small" onclick="dec('${id}')">−</button>
      <div id="qty-${id}" class="qty">${cart.items[id]||0}</div>
      <button class="btn small" onclick="inc('${id}')">+</button><br>
      <button class="btn add" onclick="inc('${id}')" data-i18n="add">${t('add')}</button>
    </div>
  </div>`;
}
function renderCategory(elId, list, isDrink=false){
  const el=document.getElementById(elId); let html="";
  list.forEach(it=>{
    if(isDrink){
      // id 格式： key_temp_price 已在 DRINKS 里，直接渲染
      html+=itemCard({id:it.id,name_zh:it.base+(it.temp==="hot"?t('hot'):t('iced')),name_en:it.base+(it.temp==="hot"?t('hot'):t('iced')),name_vi:it.base+(it.temp==="hot"?t('hot'):t('iced'))}, it.price);
    }else{
      html+=itemCard(it);
    }
  });
  if(elId==="cat-drinks"){
    html+=itemCard({...CANNED}, CANNED.price);
  }
  el.innerHTML=html;
}
function renderAll(){
  renderCategory('cat-wonton', WONTON);
  renderCategory('cat-drinks', DRINKS, true);
  renderCategory('cat-auntie', AUNTIE);
  renderCategory('cat-gx', GX);
  renderCart(); renderBreakdown();
}
function inc(id){ cart.items[id]=(cart.items[id]||0)+1; renderCart(); }
function dec(id){ if(!cart.items[id]) return; cart.items[id]--; if(cart.items[id]<=0) delete cart.items[id]; renderCart(); }
function priceOf(id){
  const m=id.match(/_(\d+\.\d{2})$/); if(m) return parseFloat(m[1]);
  const all=[...WONTON,...AUNTIE,...GX];
  const f=all.find(x=>id===x.id); if(f) return f.price;
  if(id.startsWith("canned")) return CANNED.price;
  return 0;
}
function nameOf(id){
  // for drinks: id like xxx_hot_2.50 or xxx_ice_2.70
  if(/_(hot|ice)_\d+\.\d{2}$/.test(id)){
    const base=id.replace(/_(hot|ice)_\d+\.\d{2}$/,'').replace(/_/g,' ');
    const isHot=/_(hot)_/.test(id); const nm=base.toUpperCase().replace(/\b\w/g,c=>c);
    return nm+(isHot?t('hot'):t('iced'));
  }
  const all=[...WONTON,...AUNTIE,...GX]; const f=all.find(x=>x.id===id);
  return displayName(f||{name_zh:id});
}
function fmt(n){return (Math.round(n*100)/100).toFixed(2);}
function renderCart(){
  const c=document.getElementById('cart'); c.innerHTML="";
  let subtotal=0, items=0;
  Object.keys(cart.items).forEach(id=>{
    const qty=cart.items[id]; items+=qty;
    const line=priceOf(id)*qty; subtotal+=line;
    const row=document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="left"><div class="title">${nameOf(id)} × ${qty}</div></div>
      <div style="text-align:right">
        <div style="font-weight:900">RM ${fmt(line)}</div>
        <div style="margin-top:6px">
          <button class="btn small" onclick="inc('${id}')">+</button>
          <button class="btn small" onclick="dec('${id}')">−</button>
        </div>
      </div>`;
    c.appendChild(row);
  });
  const sum=document.createElement('div'); sum.className='sum';
  sum.innerHTML = `<div style="font-weight:900">合计 Total: RM ${fmt(subtotal)}</div>`;
  c.appendChild(sum);
}

/* ============ 统计 & 分类汇总 ============ */
function todayKey(){return "lyx_stats_"+new Date().toISOString().slice(0,10);}
function loadStats(){
  const raw=localStorage.getItem(todayKey());
  return raw? JSON.parse(raw): {orders:0, items:0, sales:0, list:[], breakdown:{categories:{}, items:{}}};
}
function saveStats(st){ localStorage.setItem(todayKey(), JSON.stringify(st)); showKpis(); renderBreakdown(); }
function showKpis(){
  const st=loadStats();
  document.getElementById('kpi-orders').textContent=st.orders||0;
  document.getElementById('kpi-items').textContent=st.items||0;
  document.getElementById('kpi-sales').textContent="RM "+fmt(st.sales||0);
}

/* 分类名映射 */
const CATEGORY = {wonton:'龍兴记ᝰ云吞面',drinks:'饮料',auntie:'婶婶档',gx:'广西卷筒粉'};
function catOf(id){
  if(/_(hot|ice)_/.test(id) || id.startsWith('canned')) return 'drinks';
  if(id.startsWith('w_')) return 'wonton';
  if(id.startsWith('a_')) return 'auntie';
  if(id.startsWith('gx_'))return 'gx';
  return 'auntie';
}
function renderBreakdown(){
  const st=loadStats(); const cat=st.breakdown?.categories||{};
  const order=['wonton','drinks','auntie','gx'];
  let html = '<div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;margin-bottom:8px;font-weight:900"><div>分类</div><div>数量</div><div>金额</div></div>';
  order.forEach(k=>{
    const r=cat[k]||{qty:0,revenue:0};
    html += `<div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:6px 0;border-top:1px dashed var(--line)">
      <div>${CATEGORY[k]}</div><div>${r.qty}</div><div>RM ${fmt(r.revenue||0)}</div></div>`;
  });
  document.getElementById('breakdown').innerHTML=html;
}

/* 导出 CSV（明细/周/月） */
function csvEscape(s){ return `"${String(s).replace(/"/g,'""')}"`; }
function exportCSV(scope){
  const now=new Date();
  const keys=[];
  for(let i=0;i<32;i++){
    const d=new Date(now);
    if(scope==='today'&&i>0) break;
    d.setDate(now.getDate()-i);
    const k="lyx_stats_"+d.toISOString().slice(0,10);
    const v=localStorage.getItem(k); if(v) keys.push(k);
    if(scope==='week' && d.getDay()===0 && i>0) break;
    if(scope==='month'&& d.getDate()===1 && i>0) break;
  }
  let rows=[["date","time","table","type","items","total"].map(csvEscape).join(",")];
  keys.reverse().forEach(k=>{
    const day=k.slice(-10), st=JSON.parse(localStorage.getItem(k)||"{}");
    (st.list||[]).forEach(r=>{
      rows.push([day,r.time,r.table,r.takeaway,(r.lines||[]).join(" | "),"RM "+fmt(r.total)].map(csvEscape).join(","));
    });
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`lyx_${scope}_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}
function exportBreakdownCSV(){
  const st=loadStats(); const cat=st.breakdown?.categories||{};
  const lines=[["category","qty","revenue"]];
  ['wonton','drinks','auntie','gx'].forEach(k=>{
    const r=cat[k]||{qty:0,revenue:0};
    lines.push([CATEGORY[k],String(r.qty||0),"RM "+fmt(r.revenue||0)]);
  });
  const csv=lines.map(r=>r.map(s=>`"${String(s).replace(/"/g,'""')}"`).join(",")).join("\n");
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
  a.download=`lyx_breakdown_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}

/* 完成 & 群发 WhatsApp（5 个号码） */
const WA_LIST = ["60122847784","601161379373","60187794329","60187890583","60182925799"];
function finishAndSend(){
  if(Object.keys(cart.items).length===0){ alert('请先选择项目 / Please add items first'); return; }
  const table = document.getElementById('tableNo').value || "-";
  const type  = document.getElementById('takeaway').checked ? t('takeaway') : t('dinein');
  const note  = (document.getElementById('note').value||"").trim();

  let subtotal=0, lines=[], itemsCount=0;
  const perCat={}; // {cat:{qty,revenue}}

  Object.keys(cart.items).forEach(id=>{
    const qty=cart.items[id]; itemsCount+=qty;
    const price=priceOf(id); const lineAmt=price*qty; subtotal+=lineAmt;
    lines.push(`- ${nameOf(id)} × ${qty} = RM ${fmt(lineAmt)}`);

    const cat=catOf(id);
    if(!perCat[cat]) perCat[cat]={qty:0,revenue:0};
    perCat[cat].qty+=qty; perCat[cat].revenue+=lineAmt;
  });

  const st=loadStats();
  st.orders+=1; st.items+=itemsCount; st.sales+=subtotal;
  st.list.push({time:new Date().toLocaleString(), table, takeaway:type, lines, total:subtotal, note});
  st.breakdown = st.breakdown || {categories:{}, items:{}};
  Object.keys(perCat).forEach(cat=>{
    if(!st.breakdown.categories[cat]) st.breakdown.categories[cat]={qty:0,revenue:0};
    st.breakdown.categories[cat].qty += perCat[cat].qty;
    st.breakdown.categories[cat].revenue += perCat[cat].revenue;
  });
  saveStats(st);

  // WhatsApp 依次打开
  const NL="%0A";
  const title = `【${t('appName')}】订单 / Order`;
  const msg = [
    title, `桌号 Table: ${table}`, `类型 Type: ${type}`,'', '明细 / Items:'
  ].concat(lines).concat(['',`合计 Total: RM ${fmt(subtotal)}`, note?('备注 Notes: '+encodeURIComponent(note)):""]).join(NL);
  WA_LIST.forEach((phone,i)=> setTimeout(()=>window.open(`https://wa.me/${phone}?text=${msg}`,'_blank'), i*400));

  // 清购物车，统计不清
  cart.items={}; renderCart(); showKpis(); renderBreakdown();
}

/* 打印小票 */
function printReceipt(){
  if(Object.keys(cart.items).length===0){ alert('没有项目 / No items'); return; }
  const area=document.getElementById('print-area'); area.classList.remove('hidden');
  const table=document.getElementById('tableNo').value || '-';
  const type=document.getElementById('takeaway').checked ? t('takeaway') : t('dinein');
  let subtotal=0, body='';
  Object.keys(cart.items).forEach(id=>{
    const qty=cart.items[id]; const line=priceOf(id)*qty; subtotal+=line;
    body+=`<div>${nameOf(id)} × ${qty}<span style="float:right">RM ${fmt(line)}</span></div>`;
  });
  area.innerHTML = `
  <div style="max-width:340px;margin:0 auto;font-size:13px;line-height:1.35">
    <div style="text-align:center;font-weight:900">${t('appName')}<br><small>${t('appNameEn')}</small></div>
    <div>时间 Time: ${new Date().toLocaleString()}</div>
    <div>桌号 Table: ${table}</div>
    <div>类型 Type: ${type}</div>
    <hr>${body}<hr>
    <div style="font-weight:900">合计 Total: RM ${fmt(subtotal)}</div>
    <div style="text-align:center;margin-top:8px">谢谢惠顾，欢迎再次光临！<br><small>Thank you, please come again!</small></div>
  </div>`;
  window.print(); area.classList.add('hidden');
}

/* 查看今日明细 */
function viewToday(){
  const st=loadStats(); const lines=st.list.map((r,i)=>`${i+1}. [${r.time}] ${r.table}/${r.takeaway}\n   ${r.lines.join("\n   ")}\n   Total: RM ${fmt(r.total)}${r.note?("\n   Note: "+r.note):""}`).join("\n\n");
  alert((lines||"（暂无）") + `\n\nOrders: ${st.orders} | Items: ${st.items} | Sales: RM ${fmt(st.sales)}`);
}

/* 删单需密码 */
const DELETE_PWD = "Lyx115599$";
function deleteWithPwd(){
  const p=prompt(t('password')+" / Password");
  if(p!==DELETE_PWD){ alert(t('delFail')); return; }
  localStorage.removeItem(todayKey());
  alert(t('delSuccess'));
  showKpis(); renderBreakdown();
}

/* 启动 */
document.addEventListener('DOMContentLoaded',()=>{ applyLang(currentLang); showKpis(); });
</script>
</body>
</html>
