<!DOCTYPE html>
<html lang="zh" translate="no">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="color-scheme" content="dark">
    <meta name="description" content="龍兴记云吞面点单系统，支持多语言、离线使用和订单统计">
    <title>龍兴记ᝰ云吞面 · 点单系统 (V2.15e 果汁+加奶 · 分类/结单/统计/打印)</title>
    <link rel="manifest" href="/fail/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #740c10;
            --bg-grad: linear-gradient(180deg, #740c10 0%, #660a0e 40%, #54090c 100%);
            --ink: #ffeecf;
            --ink-strong: #fff8dd;
            --line: #f5d78a;
            --brand: #ffd86b;
            --brand-ink: #5a3b00;
            --mut: #f7e7bb;
            --shadow: 0 16px 40px rgba(0, 0, 0, .40);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            margin: 0;
            height: 100%;
            background: var(--bg);
            background-image: var(--bg-grad);
            color: var(--ink);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans SC", "PingFang SC", sans-serif;
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 14px;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, .02));
            border: 1.5px solid var(--line);
            border-radius: 18px;
            padding: 14px;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(180deg, rgba(0, 0, 0, .35), rgba(0, 0, 0, 0));
            backdrop-filter: saturate(120%) blur(6px);
            border-bottom: 1px solid rgba(241, 213, 138, .35);
        }

        .head {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
        }

        header .logo {
            height: 70px;
            width: auto;
            max-width: 205px;
            border-radius: 10px;
            display: block;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .4);
        }

        .langs {
            margin-left: auto;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .langs button {
            border: 1.5px solid var(--line);
            background: var(--brand);
            color: var(--brand-ink);
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 900;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .25);
        }

        .langs button.active {
            background: transparent;
            color: var(--ink);
            box-shadow: 0 0 0 2px rgba(241, 213, 138, .6) inset;
        }

        label {
            display: block;
            margin: 8px 0 6px;
            font-weight: 800;
            color: var(--ink-strong);
        }

        input[type="text"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1.5px solid var(--line);
            background: rgba(0, 0, 0, .18);
            color: var(--ink);
            font-weight: 900;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 680px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        #tables-quick {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        .table-chip {
            border: 1.5px solid var(--line);
            border-radius: 10px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, .06);
            color: var(--ink);
            cursor: pointer;
            min-width: 44px;
            text-align: center;
            font-weight: 900;
        }

        .table-chip.active {
            background: var(--brand);
            color: var(--brand-ink);
        }

        .cat {
            margin: 14px 0;
            border: 1.5px dashed var(--line);
            border-radius: 18px;
            overflow: hidden;
        }

        .cat-h {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: rgba(255, 255, 255, .06);
            cursor: pointer;
        }

        .cat-h h3 {
            margin: 0;
            font-size: 18px;
            letter-spacing: .3px;
            color: var(--ink-strong);
        }

        .cat-b {
            display: none;
            padding: 12px 12px 16px;
            background: rgba(0, 0, 0, .08);
        }

        .cat-b.open {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        @media (max-width: 680px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .item {
            background: rgba(255, 255, 255, .06);
            border: 1.5px solid var(--line);
            border-radius: 14px;
            padding: 12px;
        }

        .item h4 {
            margin: 0 0 6px;
            font-size: 16px;
            color: var(--ink-strong);
        }

        .item .price {
            font-weight: 900;
            color: var(--mut);
        }

        .item .extra {
            font-size: 12px;
            opacity: .9;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .act {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .btn {
            border: 2px solid var(--line);
            background: var(--brand);
            color: var(--brand-ink);
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            min-width: 44px;
            text-align: center;
            font-weight: 900;
        }

        .btn.ghost {
            background: transparent;
            color: var(--ink);
        }

        .btn.full {
            width: 100%;
        }

        .qty {
            min-width: 54px;
            text-align: center;
            font-weight: 900;
            font-size: 18px;
            color: #fff;
        }

        .cart {
            margin-top: 16px;
        }

        .cart table {
            width: 100%;
            border-collapse: collapse;
            border: 1.5px solid var(--line);
            overflow: hidden;
            border-radius: 14px;
        }

        .cart th,
        .cart td {
            padding: 10px;
            border-bottom: 1px dashed rgba(241, 213, 138, .55);
            text-align: left;
        }

        .cart tfoot td {
            font-weight: 900;
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        @media (max-width: 680px) {
            .actions {
                grid-template-columns: 1fr;
            }
        }

        .kpis {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        @media (max-width: 680px) {
            .kpis {
                grid-template-columns: 1fr 1fr;
            }
        }

        .kpis .chip {
            background: rgba(0, 0, 0, .12);
            border: 1.5px solid var(--line);
            border-radius: 14px;
            padding: 12px;
            text-align: center;
        }

        @media print {
            body {
                background: #fff;
                color: #000;
            }

            header,
            .no-print,
            .a4-menu,
            #checkoutBtn {
                display: none !important;
            }

            .ticket {
                display: block;
            }
        }

        .ticket {
            display: none;
        }

        .ticket h2 {
            margin: 0 0 8px;
        }

        .hr {
            height: 1px;
            background: repeating-linear-gradient(to right, #000 0, #000 6px, transparent 6px, transparent 12px);
            opacity: .5;
            margin: 8px 0;
        }

        .a4-menu {
            display: none;
        }

        @media print {
            .a4-menu {
                display: block;
                width: 210mm;
                min-height: 297mm;
                margin: 0 auto;
                padding: 18mm 16mm;
                background: #7a0e12;
                color: #f8e7b0;
                border: 2mm solid #f1d58a;
                border-radius: 12px;
                box-shadow: var(--shadow);
                font-family: "Noto Serif SC", "Playfair Display", serif;
            }

            .a4-menu h1 {
                margin: .2em 0 .4em 0;
                font-size: 28px;
                letter-spacing: .8px;
                text-align: center;
            }

            .a4-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8mm;
            }

            .a4-card {
                border: 1.6px solid var(--line);
                border-radius: 10px;
                padding: 6mm;
                background: rgba(255, 255, 255, .05);
            }

            .a4-title {
                font-weight: 800;
                font-size: 16px;
                margin: 0 0 4mm 0;
            }

            .a4-li {
                display: flex;
                justify-content: space-between;
                margin: 2mm 0;
            }

            .a4-li b {
                font-weight: 800;
            }
        }

        #checkoutBtn {
            position: fixed;
            right: 14px;
            bottom: 14px;
            z-index: 9999;
            box-shadow: 0 10px 26px rgba(0, 0, 0, .35);
            transform: scale(1.5);
            transform-origin: bottom right;
        }

        #statsPanel .row {
            grid-template-columns: 1fr 1fr;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 88px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, .7);
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 800;
            z-index: 99999;
            display: none;
        }

        .toast.show {
            display: block;
        }
    </style>
</head>
<body>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/fail/service-worker.js', { scope: '/fail/' })
                .then(reg => console.log('Service Worker 注册成功:', reg))
                .catch(err => console.error('Service Worker 注册失败:', err));
        }
    </script>
    
    <header class="shadow">
        <div class="head container">
            <img class="logo" src="/fail/logo.png" alt="LYX" onerror="this.style.display='none'">
            <div class="langs">
                <button data-lang="zh" class="active">中文</button>
                <button data-lang="en">English</button>
                <button data-lang="vi">Tiếng Việt</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="row">
                <div>
                    <label data-i="table_label">桌号</label>
                    <input id="tableNo" type="text" placeholder="01 / 02 / 打包">
                    <div id="tables-quick"><span class="table-chip" data-table="打包">打包</span></div>
                </div>
                <div>
                    <label data-i="type_label">用餐方式</label>
                    <select id="type">
                        <option value="dinein" data-i="dinein" selected>堂食</option>
                        <option value="takeaway" data-i="takeaway">打包</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="cats"></div>

        <div class="cart card">
            <h3 data-i="cart">订单 / Cart</h3>
            <table id="cartTable">
                <thead>
                    <tr>
                        <th data-i="item">品项</th>
                        <th data-i="qty">数量</th>
                        <th data-i="price">金额</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" data-i="total">合计 Total</td>
                        <td id="total">RM 0.00</td>
                    </tr>
                </tfoot>
            </table>

            <label style="margin-top:10px" data-i="note_label">备注</label>
            <textarea id="note" placeholder="例如：少甜 / 少冰 / 加辣" data-i-ph="note_ph"></textarea>

            <div class="actions no-print">
                <button class="btn full" id="statsBtn">今日明细统计</button>
            </div>

            <div class="kpis no-print">
                <div class="chip">
                    <div data-i="k1">订单笔数</div>
                    <div id="k_orders" style="font-weight:900;font-size:18px">0</div>
                </div>
                <div class="chip">
                    <div data-i="k2">售出件数</div>
                    <div id="k_items" style="font-weight:900;font-size:18px">0</div>
                </div>
                <div class="chip">
                    <div data-i="k3">销售金额</div>
                    <div id="k_amount" style="font-weight:900;font-size:18px">RM 0.00</div>
                </div>
            </div>
        </div>

        <div class="card no-print" id="statsPanel" style="display:none; margin-top:12px">
            <h3 data-i="stats_title">统计 · 按日期</h3>
            <div class="row">
                <div>
                    <label>日期</label>
                    <input type="date" id="statDate">
                </div>
                <div>
                    <label>操作</label>
                    <button class="btn full" id="calcBtn">统计并发送 WhatsApp</button>
                </div>
            </div>
            <div id="statResult" style="margin-top:10px; white-space: pre-wrap; font-family: monospace;"></div>
            <button class="btn full ghost" id="resetKPI" style="margin-top:10px;">重置今日累计</button>
        </div>

        <div class="ticket">
            <h2 id="t_title">龍兴记ᝰ云吞面 · 小票</h2>
            <div id="t_shop"></div><div class="hr"></div>
            <div id="t_info"></div><div class="hr"></div>
            <div id="t_items"></div><div class="hr"></div>
            <div id="t_total"></div>
            <div data-i="print_thanks">谢谢惠顾 · Terima kasih</div>
        </div>

        <button id="checkoutBtn" class="btn no-print">结单</button>
    </div>

    <div class="toast" id="toast">已添加备注：加奶</div>

    <script>
        /* ===== ① 国际化 (I18N) 配置 ===== */
        let LANG = 'zh';
        const I18N = {
            table_label: { zh: "桌号", en: "Table", vi: "Bàn" },
            type_label: { zh: "用餐方式", en: "Service Type", vi: "Hình thức" },
            dinein: { zh: "堂食", en: "Dine-in", vi: "Ăn tại chỗ" },
            takeaway: { zh: "打包", en: "Takeaway", vi: "Mang đi" },
            cart: { zh: "订单 / Cart", en: "Cart", vi: "Giỏ hàng" },
            item: { zh: "品项", en: "Item", vi: "Món" },
            qty: { zh: "数量", en: "Qty", vi: "SL" },
            price: { zh: "金额", en: "Amount", vi: "Tiền" },
            total: { zh: "合计 Total", en: "Total", vi: "Tổng" },
            note_label: { zh: "备注", en: "Note", vi: "Ghi chú" },
            note_ph: { zh: "例如：少甜 / 少冰 / 加辣", en: "e.g. less sweet / less ice / spicy", vi: "vd: ít ngọt / ít đá / cay" },
            submit: { zh: "发送到 WhatsApp", en: "Send to WhatsApp", vi: "Gửi qua WhatsApp" },
            print: { zh: "打印小票", en: "Print Ticket", vi: "In hoá đơn" },
            export: { zh: "导出本单 CSV", en: "Export this order CSV", vi: "Xuất CSV (đơn này)" },
            k1: { zh: "订单笔数", en: "Orders", vi: "Số đơn" },
            k2: { zh: "售出件数", en: "Items", vi: "Mặt hàng" },
            k3: { zh: "销售金额", en: "Sales", vi: "Doanh thu" },
            add: { zh: "+1", en: "+1", vi: "+1" },
            minus: { zh: "-1", en: "-1", vi: "-1" },
            expand: { zh: "点击展开/收起", en: "Expand/Collapse", vi: "Mở/Đóng" },
            cat_wonton: { zh: "🍜 云吞面", en: "Wonton Noodles", vi: "Mì hoành thánh" },
            cat_drinks: { zh: "🥤 饮料（冰饮 +RM0.20，罐装水除外）", en: "Drinks", vi: "Đồ uống" },
            cat_roti: { zh: "🍞 Roti", en: "Roti", vi: "Roti" },
            cat_auntie: { zh: "🍲 婶婶档（家常小炒 · 粥粉面饭）", en: "Auntie Stall", vi: "Quầy Cô" },
            cat_gx: { zh: "🥟 广西卷筒粉（古早风味）", en: "Guangxi Rice Rolls", vi: "Bánh cuốn Quảng Tây" },
            cat_juice: { zh: "🍹 果汁", en: "Juice", vi: "Nước ép" },
            print_thanks: { zh: "谢谢惠顾", en: "Thank you", vi: "Cảm ơn" },
            stats_title: { zh: "统计 · 按日期", en: "Stats by Date", vi: "Thống kê theo ngày" },
            hot: { zh: "热", en: "Hot", vi: "Nóng" },
            ice: { zh: "冰", en: "Ice", vi: "Lạnh" },
        };
        function t(k) { return (I18N[k] && I18N[k][LANG]) || k; }
        function applyI18N() {
            document.querySelectorAll('[data-i]').forEach(el => el.textContent = t(el.getAttribute('data-i')));
            document.querySelectorAll('[data-i-ph]').forEach(el => el.placeholder = t(el.getAttribute('data-i-ph')));
        }
    </script>
    
    <script>
        /* ===== ② 菜单数据 (MENU) ===== */
        // 动态拉取替换MENU
fetch("https://script.google.com/macros/s/AKfycbzVVc7M9es9BjCQ0uAN3ytSvm1x0LkZZ_dJgh5EL4MuPgNDXBVLu7anUXDwxjQq9El/exec?ts=" + Date.now())
  .then(res => res.json())
  .then(data => { MENU = data; renderMenu(); });

/* 原本硬编码菜单已移除 */
// const MENU = [
            { key: 'cat_wonton', sections: [{ title: '', items: [
                { name: '云吞面（小）', price: 6.50 },
                { name: '云吞面（中）', price: 7.30 },
                { name: '云吞面（大）', price: 8.00 },
                { name: '云吞 干捞（1 set）', price: 5.00 },
                { name: '云吞 汤（1 set）', price: 5.00 },
                { name: '加料：云吞 ×3', price: 1.00 },
            ]}]},
            { key: 'cat_drinks', sections: [{ title: '', items: [
                { name: '咖啡（热）', price: 2.30 },
                { name: '咖啡（冰）', price: 2.50 },
                { name: '咖啡C（热）', price: 2.60 },
                { name: '咖啡C（冰）', price: 2.80 },
                { name: '咖啡O（热）', price: 2.00 },
                { name: '咖啡O（冰）', price: 2.20 },
                { name: '奶茶（热）', price: 2.30 },
                { name: '奶茶（冰）', price: 2.50 },
                { name: '奶茶C（热）', price: 2.60 },
                { name: '奶茶C（冰）', price: 2.80 },
                { name: '奶茶咸C（热）', price: 2.60 },
                { name: '奶茶咸C（冰）', price: 2.80 },
                { name: '奶茶O（热）', price: 2.00 },
                { name: '奶茶O（冰）', price: 2.20 },
                { name: 'Nescafe（热）', price: 2.80 },
                { name: 'Nescafe（冰）', price: 3.00 },
                { name: 'Milo（热）', price: 2.60 },
                { name: 'Milo（冰）', price: 2.80 },
                { name: 'Milo C（热）', price: 2.80 },
                { name: 'Milo C（冰）', price: 3.00 },
                { name: 'Milo O（热）', price: 2.60 },
                { name: 'Milo O（冰）', price: 2.80 },
                { name: 'Neslo（热）', price: 2.80 },
                { name: 'Neslo（冰）', price: 3.00 },
                { name: '鸳鸯（热）', price: 2.80 },
                { name: '鸳鸯（冰）', price: 3.00 },
                { name: 'Nestle（热）', price: 2.80 },
                { name: '钓鱼 “茶包”', price: 1.00 },
                { name: '凉茶（热）', price: 1.50 },
                { name: '凉茶（冰）', price: 1.70 },
                { name: '玉米（热）', price: 1.50 },
                { name: '玉米（冰）', price: 1.70 },
                { name: '罐装水', price: 2.50 },
            ]}]},
            { key: 'cat_roti', sections: [{ title: '', items: [
                { name: 'Roti', price: 2.00 },
                { name: 'Roti Butter', price: 2.50 },
                { name: '生熟蛋 “Set”', price: 2.40 }
            ]}]},
            { key: 'cat_juice', sections: [{ title: '', items: [
                { name: '苹果汁', price: 5.00 },
                { name: '橙汁', price: 5.00 },
                { name: '萝卜汁', price: 5.00 },
                { name: '西瓜汁', price: 5.00 },
                { name: '蜜瓜汁', price: 5.00 },
            ]}]},
            { key: 'cat_auntie', sections: [{ title: '', items: [
                { name: '苦瓜米粉', price: 6.00 },
                { name: 'Nasi Lemak（蛋）', price: 3.00 },
                { name: 'Nasi Lemak（鸡）', price: 6.00 },
                { name: '面粉糕', price: 6.00 },
                { name: '红烧饭', price: 6.00 },
                { name: '鱼粥（猪肉）', price: 6.00 },
                { name: '鱼粥（鸡肉）', price: 6.00 },
                { name: '面线', price: 6.00 },
                { name: '卤肉饭', price: 6.00 },
                { name: '果条汤', price: 6.00 },
                { name: '加皮蛋', price: 1.00 },
                { name: '酸笋瓜', price: 1.50 },
                { name: '酸羊角豆', price: 1.50 },
                { name: '酸苦瓜', price: 1.50 },
                { name: '酸豆腐', price: 1.50 },
                { name: '炸鸡翅膀', price: 3.00 },
                { name: '煎鸡蛋', price: 1.00 },
            ]}]},
            { key: 'cat_gx', sections: [{ title: '', items: [
                { name: '素粉 (kosong)', price: 1.00 },
                { name: '蔬菜卷筒粉', price: 2.00 },
                { name: '菜加肉卷筒粉', price: 3.00 },
                { name: '肉卷筒粉', price: 3.00 },
                { name: '全家福卷筒粉', price: 4.00 },
                { name: '春卷', price: 1.00 },
                { name: '芋头米糕', price: 1.00 },
            ]}]},
        ];
    </script>
        
    <script>
        /* ===== ③ 菜单构建 (动态生成DOM) ===== */
        const catsEl = document.getElementById('cats');
        const NAME_TO_CAT = new Map();

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function parseDrinkName(n) {
            const m = n.match(/^([\u4e00-\u9fa5A-Za-z ]+?)(?:\s?(C|O|咸C))?(?:（(热|冰)）)?$/);
            if (!m) return { base: n, variant: '默认', temp: '默认' };
            return { base: m[1].trim(), variant: m[2] || '默认', temp: m[3] || '默认' };
        }

        function renderMenu() {
            catsEl.innerHTML = '';
            MENU.forEach((cat) => {
                const wrap = document.createElement('div');
                wrap.className = 'cat card';
                wrap.innerHTML = `<div class="cat-h" data-toggle tabindex="0"><h3>${t(cat.key)}</h3><div style="opacity:.8">${t('expand')}</div></div><div class="cat-b"><div class="grid"></div></div>`;
                const grid = wrap.querySelector('.grid');

                if (cat.key === 'cat_drinks') {
                    const all = cat.sections.flatMap(s => s.items);
                    const groups = {};
                    all.forEach(it => {
                        const p = parseDrinkName(it.name);
                        groups[p.base] = groups[p.base] || {};
                        groups[p.base][p.variant] = groups[p.base][p.variant] || { hot: null, ice: null, default: null };
                        if (p.temp === '热') groups[p.base][p.variant].hot = { price: it.price, full: `${p.base}${p.variant==='默认'?'':' '+p.variant}（热）` };
                        if (p.temp === '冰') groups[p.base][p.variant].ice = { price: it.price, full: `${p.base}${p.variant==='默认'?'':' '+p.variant}（冰）` };
                        if (p.temp === '默认') groups[p.base][p.variant].default = { price: it.price, full: it.name };
                    });

                    Object.keys(groups).forEach(base => {
                        const variants = groups[base];
                        const variantKeys = Object.keys(variants).sort((a,b)=>{ const order = {'默认':0,'C':1,'O':2,'咸C':3}; return (order[a]??9)-(order[b]??9); });
                        const baseId = `base-${base.replace(/\s+/g,'_')}`;
                        const baseCard = document.createElement('div');
                        baseCard.className = 'item';
                        baseCard.innerHTML = `
                          <h4 data-base-toggle="${baseId}" style="cursor:pointer" tabindex="0">${escapeHTML(base)}</h4>
                          <div class="base-body" id="${baseId}" style="display:none; margin-top:8px; gap:10px"></div>
                        `;
                        grid.appendChild(baseCard);
                        const baseBody = baseCard.querySelector('.base-body');

                        variantKeys.forEach(variant => {
                            const node = variants[variant];
                            const title = (variant==='默认') ? base : `${base} ${variant}`;
                            const hot = node.hot, ice = node.ice, def = node.default;
                            const hotId = hot ? `${cat.key}_${hot.full}__${hot.price}` : '';
                            const iceId = ice ? `${cat.key}_${ice.full}__${ice.price}` : '';
                            const defId = def ? `${cat.key}_${def.full}__${def.price}` : '';
                            if (hot) NAME_TO_CAT.set(hot.full, 'cat_drinks');
                            if (ice) NAME_TO_CAT.set(ice.full, 'cat_drinks');
                            if (def) NAME_TO_CAT.set(def.full, 'cat_drinks');

                            let content = '';
                            if (def) {
                                content += `
                                  <div>
                                    <div style="font-weight:800;opacity:.9">${escapeHTML(title)}</div>
                                    <div class="price">RM ${Number(def.price).toFixed(2)}</div>
                                    <div class="act">
                                      <button class="btn ghost" data-sub="${defId}">${t('minus')}</button>
                                      <div class="qty" data-qty="${defId}">0</div>
                                      <button class="btn" data-add="${defId}">${t('add')}</button>
                                    </div>
                                  </div>
                                `;
                            } else {
                                content += `
                                  <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                                    <div>
                                      <div style="font-weight:800;opacity:.9">${t('hot')}</div>
                                      <div class="price">RM ${hot ? Number(hot.price).toFixed(2) : '—'}</div>
                                      <div class="act">
                                        <button class="btn ghost" ${hot ? `data-sub="${hotId}"` : 'disabled'}>${t('minus')}</button>
                                        <div class="qty" data-qty="${hotId}">0</div>
                                        <button class="btn" ${hot ? `data-add="${hotId}"` : 'disabled'}>${t('add')}</button>
                                      </div>
                                    </div>
                                    <div>
                                      <div style="font-weight:800;opacity:.9">${t('ice')}</div>
                                      <div class="price">RM ${ice ? Number(ice.price).toFixed(2) : '—'}</div>
                                      <div class="act">
                                        <button class="btn ghost" ${ice ? `data-sub="${iceId}"` : 'disabled'}>${t('minus')}</button>
                                        <div class="qty" data-qty="${iceId}">0</div>
                                        <button class="btn" ${ice ? `data-add="${iceId}"` : 'disabled'}>${t('add')}</button>
                                      </div>
                                    </div>
                                  </div>
                                `;
                            }
                            baseBody.insertAdjacentHTML('beforeend', `
                              <div class="card" style="border:1px dashed var(--line); border-radius:12px; padding:10px">
                                <div style="font-weight:800; opacity:.95; margin-bottom:6px">${escapeHTML(title)}</div>
                                ${content}
                              </div>
                            `);
                        });
                    });
                } else {
                    cat.sections.forEach(sec => {
                        sec.items.forEach(it => {
                            NAME_TO_CAT.set(it.name, cat.key);
                            const id = `${cat.key}_${it.name}__${it.price}`;
                            const isJuice = (cat.key === 'cat_juice');
                            grid.insertAdjacentHTML('beforeend', `
                                <div class="item">
                                    <h4>${escapeHTML(it.name)}</h4>
                                    <div class="price">RM ${Number(it.price).toFixed(2)}</div>
                                    ${isJuice ? `<div class="extra"><label><input type="checkbox" data-milk="${id}"> 加奶</label></div>` : ''}
                                    <div class="act">
                                        <button class="btn ghost" data-sub='${id}'>${t('minus')}</button>
                                        <div class="qty" data-qty='${id}'>0</div>
                                        <button class="btn" data-add='${id}'>${t('add')}</button>
                                    </div>
                                </div>`);
                        });
                    });
                }

                catsEl.appendChild(wrap);
            });
        }

        renderMenu();

        catsEl.addEventListener('click', e => {
            const h = e.target.closest('[data-toggle]');
            if (h) { const b = h.parentElement.querySelector('.cat-b'); b.classList.toggle('open'); }
        });
        catsEl.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ' ') {
                const h = e.target.closest('[data-toggle]');
                if (h) {
                    e.preventDefault();
                    const b = h.parentElement.querySelector('.cat-b');
                    b.classList.toggle('open');
                }
            }
        });
        catsEl.addEventListener('click', e => {
            const h = e.target.closest('[data-base-toggle]');
            if (!h) return;
            const id = h.getAttribute('data-base-toggle');
            const body = document.getElementById(id);
            if (!body) return;
            body.style.display = body.style.display === 'none' ? 'block' : 'none';
        });
        catsEl.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ' ') {
                const h = e.target.closest('[data-base-toggle]');
                if (!h) return;
                e.preventDefault();
                const id = h.getAttribute('data-base-toggle');
                const body = document.getElementById(id);
                if (!body) return;
                body.style.display = body.style.display === 'none' ? 'block' : 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.cat-b').forEach(b => b.classList.remove('open'));
        });
    </script>
    
    <script>
        /* ===== ④ 购物车逻辑 ===== */
        let CART = [];
        function ensureNoteMilk(itemName) {
            const note = document.getElementById('note');
            const tag = `${itemName} 加奶`;
            if (!note.value.includes(tag)) {
                note.value = (note.value ? note.value + ' · ' : '') + tag;
            }
        }
        function addToCart(name, price, delta = 1, isMilk = false, cat) {
            const p = Number(price);
            if (isNaN(p) || !isFinite(p)) { return; }
            const d = Number(delta);
            if (isNaN(d) || !isFinite(d) || d === 0) { return; }

            const displayName = isMilk ? `${name}（加奶）` : name;
            let found = CART.find(x => x.name === displayName && x.price === p);
            
            if (found) {
                found.qty = Math.max(0, found.qty + d);
                if (found.qty <= 0) CART = CART.filter(x => x !== found);
            } else if (d > 0) {
                CART.push({ name: displayName, price: p, qty: 1, cat });
            }
            renderCart();
            syncAllQty();
        }
        function syncAllQty() {
            document.querySelectorAll('.qty[data-qty]').forEach(q => {
                const key = q.getAttribute('data-qty');
                const [cat, name, priceStr] = key.split('__');
                const price = Number(priceStr);
                let totalQty = 0;

                if (cat === 'cat_juice') {
                    // 对于果汁，汇总基础版和加奶版
                    const baseItemQty = CART.find(it => it.name === name && it.price === price)?.qty || 0;
                    const milkItemQty = CART.find(it => it.name === `${name}（加奶）` && it.price === price)?.qty || 0;
                    totalQty = baseItemQty + milkItemQty;
                } else {
                    // 对于其他项目，直接查找
                    totalQty = CART.find(it => it.name === name && it.price === price)?.qty || 0;
                }
                q.textContent = totalQty;
            });
        }
        catsEl.addEventListener('click', e => {
            const ad = e.target.closest('[data-add]');
            const sb = e.target.closest('[data-sub]');
            
            if (ad) {
                const id = ad.getAttribute('data-add');
                const [cat, name, price] = id.split('__');
                let milk = false;
                if (cat === 'cat_juice') {
                    const chk = document.querySelector(`[data-milk='${id}']`);
                    milk = !!(chk && chk.checked);
                    if (milk) ensureNoteMilk(name);
                }
                addToCart(name, price, 1, milk, cat);
                showToast(`已添加 ${name}`);
            }
            if (sb) {
                const id = sb.getAttribute('data-sub');
                const [cat, name, price] = id.split('__');
                let milk = false;
                // [FIXED] 扣减时也检查 "加奶" 状态
                if (cat === 'cat_juice') {
                    const chk = document.querySelector(`[data-milk='${id}']`);
                    milk = !!(chk && chk.checked);
                }
                addToCart(name, price, -1, milk, cat);
                showToast(`已减少 ${name}`);
            }
        }, { capture: true });

        function renderCart() {
            const tb = document.querySelector('#cartTable tbody');
            tb.innerHTML = '';
            let total = 0, items = 0;
            CART.forEach((it) => {
                if (it.qty > 0 && isFinite(it.price) && isFinite(it.qty)) {
                    const itemTotal = it.qty * it.price;
                    total += itemTotal;
                    items += it.qty;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${escapeHTML(it.name)}</td><td>${it.qty}</td><td>RM ${(itemTotal).toFixed(2)}</td>`;
                    tb.appendChild(tr);
                }
            });
            document.getElementById('total').textContent = 'RM ' + (isFinite(total) ? total.toFixed(2) : '0.00');
        }
    </script>
    
    <script>
        /* ===== ⑤ 订单提交与同步 ===== */
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        async function submitOrderToSheet() {
            if (!CART.length) {
                showToast('购物车为空');
                return;
            }

            if (!navigator.onLine) {
                showToast('网络不可用，请检查连接');
                return;
            }

            const currentTotal = CART.reduce((sum, it) => sum + (it.qty * it.price || 0), 0);

            const orderData = {
                itemName: CART.map(it => it.name).join(", "),
                quantity: CART.map(it => it.qty).join(", "),
                unitPrice: CART.map(it => it.price).join(", "),
                totalPrice: currentTotal.toFixed(2),
                note: (document.getElementById('note').value || '').trim() || '无备注',
                tableNo: document.getElementById('tableNo').value || 'N/A',
                type: document.getElementById('type').value
            };

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbzMXzGN6g9-wpBbGxSo3-iK7faz2UhTrnceVlwX-B6FEWT5URuPlB8OPdRUrXpD2L2wlQ/exec', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();
                if (result.success) {
                    showToast('订单已同步到表格');
                    if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
                    
                    pushOrderToHistory({
                        ts: Date.now(),
                        total: Number(orderData.totalPrice),
                        items: CART.map(it => ({ name: it.name, price: it.price, qty: it.qty, cat: it.cat }))
                    });
                    bumpKPI(currentTotal, CART.reduce((s, it) => s + it.qty, 0));
                    
                    CART = [];
                    renderCart();
                    syncAllQty();
                } else {
                    throw new Error(result.message || '同步失败');
                }
            } catch (error) {
                showToast('同步出错: ' + error.message);
                console.error('Error during submission:', error);
            }
        }
        document.getElementById('checkoutBtn').addEventListener('click', submitOrderToSheet);
    </script>
    
    <script>
        /* ===== ⑥ 导出与打印 ===== */
        function exportCSV() {
            const rows = [["Item", "Qty", "Unit Price", "Amount"]];
            let total = 0;
            CART.forEach(it => { const amt = it.qty * it.price; total += amt; rows.push([it.name, it.qty, it.price, amt]); });
            rows.push(["Total", "", "", total.toFixed(2)]);
            const csv = '\uFEFF' + rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'order.csv';
            a.click();
        }

        function printTicket() {
            const tShop = document.getElementById('t_shop');
            const tInfo = document.getElementById('t_info');
            const tItems = document.getElementById('t_items');
            const tTotal = document.getElementById('t_total');
            const table = (document.getElementById('tableNo').value || '').trim();
            const type = document.getElementById('type').value;
            const note = (document.getElementById('note').value || '').trim();
            const sum = CART.reduce((s, it) => s + it.qty * it.price, 0);
            document.getElementById('t_title').textContent = '龍兴记ᝰ云吞面 · 小票';
            const logo = '';
            tShop.innerHTML = `${logo}<b>龍运轩ᝰ美食中心</b>`;
            tInfo.textContent = `桌号: ${table || '-'} · ${type === 'dinein' ? '堂食' : '打包'}${note ? ` · 备注: ${note}` : ''}`;
            tItems.innerHTML = CART.map(it => `${escapeHTML(it.name)} ×${it.qty} — RM ${(it.qty * it.price).toFixed(2)}`).join('<br>');
            tTotal.textContent = '合计: RM ' + sum.toFixed(2);
            window.print();
        }

        /* ===== ⑦ KPI 统计 ===== */
        const KEY_ORDERS = 'LYX_ACCUM_ORDERS_SIMPLE';
        const KEY_AMOUNT = 'LYX_ACCUM_AMOUNT_SIMPLE';
        const KEY_ITEMS = 'LYX_ACCUM_ITEMS_SIMPLE';
        
        function bumpKPI(sum, itemsCount) {
            const orders = Number(localStorage.getItem(KEY_ORDERS) || 0) + 1;
            const amount = Number(localStorage.getItem(KEY_AMOUNT) || 0) + Number(sum || 0);
            const items = Number(localStorage.getItem(KEY_ITEMS) || 0) + itemsCount;
            localStorage.setItem(KEY_ORDERS, String(orders));
            localStorage.setItem(KEY_AMOUNT, String(amount));
            localStorage.setItem(KEY_ITEMS, String(items));
            updateKpiDisplay();
        }
        function updateKpiDisplay() {
            const orders = Number(localStorage.getItem(KEY_ORDERS) || 0);
            const amount = Number(localStorage.getItem(KEY_AMOUNT) || 0);
            const items = Number(localStorage.getItem(KEY_ITEMS) || 0);
            document.getElementById('k_orders').textContent = orders;
            document.getElementById('k_amount').textContent = 'RM ' + amount.toFixed(2);
            document.getElementById('k_items').textContent = items;
        }

        /* ===== ⑧ 历史订单 & 日期统计 ===== */
        const KEY_ORDERS_JSON = 'LYX_ORDERS_V1';
        function loadOrders() { try { return JSON.parse(localStorage.getItem(KEY_ORDERS_JSON) || '[]'); } catch { return []; } }
        function saveOrders(list) { localStorage.setItem(KEY_ORDERS_JSON, JSON.stringify(list)); }
        function pushOrderToHistory(payload) {
            if (!payload.ts || !payload.items || !Array.isArray(payload.items)) return;
            const list = loadOrders();
            list.push(payload);
            if (list.length > 1000) list.shift();
            saveOrders(list);
        }

        function calcStatsByDate(yyyy_mm_dd) {
            const list = loadOrders();
            if (!yyyy_mm_dd) return { orders: 0, amount: 0, cat: {} };
            const [Y, M, D] = yyyy_mm_dd.split('-').map(Number);
            const start = new Date(Y, M - 1, D, 0, 0, 0, 0).getTime();
            const end = new Date(Y, M - 1, D, 23, 59, 59, 999).getTime();
            const dayOrders = list.filter(o => o.ts >= start && o.ts <= end);
            let sum = 0;
            const catMap = new Map();
            dayOrders.forEach(o => {
                sum += o.total;
                o.items.forEach(it => {
                    const catKey = it.cat || 'unknown';
                    const m = catMap.get(catKey) || { amount: 0, items: 0 };
                    m.amount += it.price * it.qty;
                    m.items += it.qty;
                    catMap.set(catKey, m);
                });
            });
            const cat = [...catMap.entries()]
                .sort((a, b) => b[1].amount - a[1].amount)
                .reduce((obj, [k, v]) => { obj[k] = v; return obj; }, {});
            return { orders: dayOrders.length, amount: sum, cat };
        }
    </script>
    
    <script>
        /* ===== ⑨ 初始化与事件绑定 ===== */
        document.addEventListener('DOMContentLoaded', () => {
            applyI18N();
            updateKpiDisplay();

            // 语言切换
            document.querySelectorAll('.langs button').forEach(b => b.addEventListener('click', () => {
                document.querySelector('.langs button.active').classList.remove('active');
                b.classList.add('active');
                LANG = b.getAttribute('data-lang');
                applyI18N();
                renderMenu();
            }));

            // 快捷桌号
            document.querySelectorAll('.table-chip').forEach(t => t.addEventListener('click', () => {
                document.getElementById('tableNo').value = t.getAttribute('data-table');
                document.querySelectorAll('.table-chip').forEach(x => x.classList.remove('active'));
                t.classList.add('active');
            }));

            // [ADDED] 统计面板功能
            const statsBtn = document.getElementById('statsBtn');
            const statsPanel = document.getElementById('statsPanel');
            const calcBtn = document.getElementById('calcBtn');
            const resetKPIBtn = document.getElementById('resetKPI');
            const statDateInput = document.getElementById('statDate');
            const statResultDiv = document.getElementById('statResult');
            
            // 默认日期为今天
            statDateInput.valueAsDate = new Date();

            statsBtn.addEventListener('click', () => {
                statsPanel.style.display = statsPanel.style.display === 'none' ? 'block' : 'none';
            });

            calcBtn.addEventListener('click', () => {
                const date = statDateInput.value;
                if (!date) {
                    showToast('请先选择日期');
                    return;
                }
                const stats = calcStatsByDate(date);
                
                // 1. 显示结果到界面
                let resultText = `===== ${date} 统计 =====\n`;
                resultText += `总金额: RM ${stats.amount.toFixed(2)}\n`;
                resultText += `总订单: ${stats.orders}\n\n`;
                resultText += `----- 分类详情 -----\n`;
                
                let waMsg = `*龍兴记 ${date} 账目*\n\n`;
                waMsg += `*总销售额: RM ${stats.amount.toFixed(2)}*\n`;
                waMsg += `*总订单数: ${stats.orders}*\n\n`;
                waMsg += `*--- 各类目详情 ---*\n`;

                for (const catKey in stats.cat) {
                    const catData = stats.cat[catKey];
                    const catName = t(catKey) || catKey;
                    const line = `${catName}: RM ${catData.amount.toFixed(2)} (${catData.items} 件)\n`;
                    resultText += line;
                    waMsg += `*${catName}*: RM ${catData.amount.toFixed(2)} (${catData.items} 件)\n`;
                }
                statResultDiv.textContent = resultText;
                
                // 2. 发送到 WhatsApp
                const encodedMsg = encodeURIComponent(waMsg);
                window.open(`https://wa.me/?text=${encodedMsg}`);
            });

            resetKPIBtn.addEventListener('click', () => {
                if (confirm('确定要重置首页显示的今日累计数据吗？此操作不可逆！')) {
                    localStorage.removeItem(KEY_ORDERS);
                    localStorage.removeItem(KEY_AMOUNT);
                    localStorage.removeItem(KEY_ITEMS);
                    updateKpiDisplay();
                    showToast('今日累计统计已重置');
                }
            });
        });
    </script>
</body>
</html>
