<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>龍運轩ᝰ美食中心 · LYX Food Center</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;
    --blue:#1d4ed8;--green:#059669;--accent:#0ea5e9;
    /* 底部按钮宽度：蓝25%，绿75% */
    --blue-fr:1;--green-fr:3;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:inherit;text-decoration:none}

  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0ea5e9,#0284c7);color:#fff;padding:14px 12px}
  .header-in{max-width:1100px;margin:0 auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  h1 small{display:block;opacity:.9;font-weight:600}
  .lang{margin-left:auto;display:flex;gap:8px}
  .chip{background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.35);padding:6px 10px;border-radius:999px;color:#fff;font-weight:700}
  .lang button{border:1px solid rgba(255,255,255,.5);background:rgba(255,255,255,.12);color:#fff;padding:6px 10px;border-radius:999px}
  .lang button.active{background:#fff;color:#0b3a55}

  .wrap{max-width:1100px;margin:16px auto;padding:0 12px 20px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(2,8,23,.05)}
  .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:16px}
  .section{padding:10px 12px 14px}

  /* —— 分类折叠（details/summary） —— */
  details.cat{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden;margin:10px 0}
  details.cat+details.cat{margin-top:12px}
  details.cat[open]{box-shadow:0 8px 24px rgba(2,8,23,.05)}
  summary.cat-head{list-style:none;cursor:pointer;padding:12px 14px;font-weight:900;display:flex;align-items:center;gap:10px;background:#fff7ed}
  summary.cat-head::-webkit-details-marker{display:none}
  .caret{width:10px;height:10px;border-right:2px solid #a16207;border-bottom:2px solid #a16207;transform:rotate(-45deg);transition:.2s}
  details[open] .caret{transform:rotate(45deg)}

  .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (max-width:720px){.cards{grid-template-columns:1fr}}

  .item{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;display:flex;gap:12px;align-items:center}
  .item .left{flex:1}
  .title{font-weight:800}
  .sub{font-size:12px;color:var(--muted);line-height:1.2}

  /* —— 加号/减号 & 数量加大 —— */
  .btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .btn.small{
    background:#f3f4f6;
    width:44px;height:44px;       /* 按钮更大 */
    font-size:20px;font-weight:900;
    border-radius:12px;
  }
  .qty{
    min-width:48px;               /* 数量更宽 */
    text-align:center;
    font-weight:900;
    font-size:20px;               /* 数字更大 */
  }
  .btn.add{background:#0ea5e9;border-color:#0ea5e9;color:#fff}

  .sticky{position:sticky;top:84px}
  .sum{border-top:none;margin-top:0;padding-top:0}

  /* 底部操作行：蓝25% + 绿75% */
  .actions-row{
    display:grid;grid-template-columns:var(--blue-fr)fr var(--green-fr)fr;gap:12px;margin:8px 0 0
  }
  .btn-xl{height:56px;font-weight:900;font-size:16px;border-radius:12px;display:flex;align-items:center;justify-content:center}
  .btn-blue{background:var(--blue);border-color:var(--blue);color:#fff}
  .btn-green{background:var(--green);border-color:var(--green);color:#fff}

  .kvs{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .kv{border:1px dashed var(--line);border-radius:12px;padding:12px;text-align:center;background:#fff}
  .kv b{font-size:18px}

  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  textarea{width:100%;min-height:76px;padding:10px;border:1px solid var(--line);border-radius:10px}
  .muted{color:var(--muted);font-size:12px}
  .danger{background:#ef4444;border-color:#ef4444;color:#fff}
</style>
</head>
<body>

<header>
  <div class="header-in">
    <div>
      <h1>龍運轩ᝰ美食中心<small>LYX Food Center</small></h1>
      <div class="muted" id="navcats">
        <a class="chip" href="#cat-wonton">龍兴记ᝰ云吞面</a>
        <a class="chip" href="#cat-drinks">饮料</a>
        <a class="chip" href="#cat-aunt">婶婶档</a>
      </div>
    </div>
    <div class="lang">
      <button id="lang-zh" class="active" onclick="setLang('zh')">中文</button>
      <button id="lang-en" onclick="setLang('en')">English</button>
      <button id="lang-vi" onclick="setLang('vi')">Tiếng Việt</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- 左：菜单（分类默认折叠） -->
  <section class="panel">
    <h3>点餐 / Order</h3>
    <div class="section">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin:4px 6px 12px">
        <label>桌号 Table<br>
          <input id="tableNo" style="width:140px;padding:10px;border-radius:12px;border:1px solid var(--line)">
        </label>
        <label class="btn" style="display:flex;gap:6px;align-items:center">
          <input type="checkbox" id="takeaway"> 外带 <span class="muted">/ Takeaway</span>
        </label>
      </div>

      <!-- 龍兴记ᝰ云吞面 -->
      <details id="cat-wonton" class="cat">
        <summary class="cat-head"><span class="caret"></span> 龍兴记ᝰ云吞面 / LYX Wonton Noodles</summary>
        <div class="section"><div id="menuWonton" class="cards"></div></div>
      </details>

      <!-- 饮料 -->
      <details id="cat-drinks" class="cat">
        <summary class="cat-head"><span class="caret"></span> 饮料 / Drinks</summary>
        <div class="section">
          <div class="muted" style="margin:0 0 8px">规则：所有饮料 冰 +RM0.20（罐装水固定 RM3.00，不加价）</div>
          <div id="menuDrinks" class="cards"></div>
        </div>
      </details>

      <!-- 婶婶档 -->
      <details id="cat-aunt" class="cat">
        <summary class="cat-head"><span class="caret"></span> 婶婶档 / Auntie's Stall</summary>
        <div class="section"><div id="menuAunt" class="cards"></div></div>
      </details>

    </div>
  </section>

  <!-- 右：订单 -->
  <aside class="panel sticky">
    <h3>订单 / Cart</h3>
    <div id="cart" class="section"></div>

    <div class="section">
      <label style="display:block">备注 Notes
        <textarea id="note" placeholder="例：少糖 / 少冰 / 加辣 ..."></textarea>
      </label>

      <!-- 只有这一排：蓝25% + 绿75% -->
      <div class="actions-row">
        <button class="btn btn-xl btn-blue" onclick="printReceiptSafe()">打印小票</button>
        <button class="btn btn-xl btn-green" onclick="completeAndShare()">完成并统计（群聊）</button>
      </div>

      <div class="tools">
        <button class="btn" onclick="newOrder()">新订单</button>
        <span class="muted">不会清理统计；仅清空购物车。</span>
      </div>
    </div>
  </aside>
</div>

<!-- 统计区 -->
<div class="wrap" style="grid-template-columns:1fr">
  <section class="panel">
    <h3>今日统计 / Today</h3>
    <div class="section">
      <div class="kvs">
        <div class="kv"><div>订单笔数</div><b id="statOrders">0</b></div>
        <div class="kv"><div>售出件数</div><b id="statQty">0</b></div>
        <div class="kv"><div>销售金额</div><b id="statAmount">RM 0.00</b></div>
      </div>
      <div class="tools">
        <button class="btn" onclick="showDetails()">查看明细</button>
        <button class="btn" onclick="exportCSV('day')">导出今日 CSV</button>
        <button class="btn" onclick="exportCSV('week')">导出本周 CSV</button>
        <button class="btn" onclick="exportCSV('month')">导出本月 CSV</button>
        <button class="btn danger" onclick="secureDelete()">删单（需密码）</button>
      </div>
      <div id="details" class="muted" style="margin-top:8px"></div>
    </div>
  </section>
</div>

<!-- 打印区（浏览器用） -->
<div id="print-area" style="display:none"></div>

<script>
/* ====== 基本配置 ====== */
var settings = {
  cafeName: "龍運轩ᝰ美食中心",
  cafeNameEn: "LYX Food Center",
  currency: "RM",
  whatsappList: ["60122847784","601161379373","60187794329","60187890583","60182925799"],
  printFooter: "谢谢惠顾，欢迎再次光临！",
  printFooterEn: "Thank you, please come again!"
};
function fmt(n){return (Math.round(n*100)/100).toFixed(2);}
const IS_WEBVIEW = /wv/.test(navigator.userAgent.toLowerCase());

/* ====== 多语言（极简） ====== */
var LANG = localStorage.getItem('lyx_lang') || 'zh';
function setLang(l){ LANG=l; localStorage.setItem('lyx_lang',l);
  document.querySelectorAll('.lang button').forEach(b=>b.classList.remove('active'));
  document.getElementById('lang-'+l).classList.add('active');
  renderAll();
}

/* ====== 菜单数据 ====== */
/* 龍兴记ᝰ云吞面 */
const WONTON = [
  {id:"w_dry_s",  name:"云吞面 干捞（小）",  nameEn:"Wonton Noodle Dry (S)", price:6.50, unit:"pc"},
  {id:"w_dry_m",  name:"云吞面 干捞（中）",  nameEn:"Wonton Noodle Dry (M)", price:7.50, unit:"pc"},
  {id:"w_dry_l",  name:"云吞面 干捞（大）",  nameEn:"Wonton Noodle Dry (L)", price:8.50, unit:"pc"},
  {id:"w_soup_s", name:"云吞面 汤（小）",     nameEn:"Wonton Noodle Soup (S)", price:6.50, unit:"pc"},
  {id:"w_soup_m", name:"云吞面 汤（中）",     nameEn:"Wonton Noodle Soup (M)", price:7.50, unit:"pc"},
  {id:"w_soup_l", name:"云吞面 汤（大）",     nameEn:"Wonton Noodle Soup (L)", price:8.50, unit:"pc"},
  {id:"wantan_dry", name:"云吞 干捞（一份）", nameEn:"Wantan Dry (1 portion)", price:5.00, unit:"pc"},
  {id:"wantan_soup",name:"云吞 汤（一份）",   nameEn:"Wantan Soup (1 portion)", price:5.00, unit:"pc"},
  {id:"addon_3",   name:"加料：云吞 ×3",    nameEn:"Add-on: 3 Wantans",      price:1.00, unit:"pc"}
];

/* 饮料（冰 +0.20；罐装固定 3.00） */
const DRINK_BASE = [
  ["咖啡",2.30],["咖啡C",2.50],["咖啡O",2.00],
  ["奶茶",2.30],["奶茶C",2.50],["奶茶咸C",2.50],
  ["Milo",2.60],["Milo C",2.80],["Milo O",2.60]
];
const CANNED = ["Coke","100 Plus","Sprite","Green Tea","Soya","Kikapo","Fanta","Xiao Mai Chao","罐装水"];
let DRINKS=[];
DRINK_BASE.forEach(([n,h])=>{
  let k=n.toLowerCase().replace(/\s+/g,'_');
  DRINKS.push({id:k+"_hot",name:n+"（热）",nameEn:n+" (Hot)",price:h,unit:"pc"});
  DRINKS.push({id:k+"_ice",name:n+"（冰）",nameEn:n+" (Iced)",price:h+0.20,unit:"pc"});
});
CANNED.forEach(n=>{
  let k=n.toLowerCase().replace(/[^a-z0-9]+/g,'_');
  DRINKS.push({id:k, name:n, nameEn:n, price:3.00, unit:"pc"});
});

/* 婶婶档 */
const AUNT = [
  {id:"bitter_bihun", name:"苦瓜米粉", nameEn:"Bitter Gourd Bihun", price:6.00, unit:"pc"},
  {id:"nasi_lemak_chicken", name:"Nasi Lemak（有鸡肉）", nameEn:"Nasi Lemak (Chicken)", price:6.00, unit:"pc"},
  {id:"nasi_lemak_egg", name:"Nasi Lemak（只有鸡蛋）", nameEn:"Nasi Lemak (Egg only)", price:3.00, unit:"pc"},
  {id:"mee_fung_kueh", name:"面粉粿", nameEn:"Mee Hoon Kueh", price:6.00, unit:"pc"},
  {id:"red_braised_rice", name:"红烧饭", nameEn:"Braised Rice", price:6.00, unit:"pc"},
  {id:"fish_porridge_pork", name:"鱼粥（猪肉）", nameEn:"Fish Porridge (Pork)", price:6.00, unit:"pc"},
  {id:"fish_porridge_chicken", name:"鱼粥（鸡肉）", nameEn:"Fish Porridge (Chicken)", price:6.00, unit:"pc"},
  {id:"mee_sua", name:"面线", nameEn:"Mee Sua", price:6.00, unit:"pc"},
  {id:"lor_meat_rice", name:"卤肉饭", nameEn:"Lor Meat Rice", price:6.00, unit:"pc"},
  {id:"kuey_teow_soup", name:"果条汤", nameEn:"Kuey Teow Soup", price:6.00, unit:"pc"}
];

/* ====== 运行态 ====== */
var cart={items:{}};

/* ====== 工具 ====== */
function allItems(){return WONTON.concat(DRINKS,AUNT);}
function findItem(id){return allItems().find(x=>x.id===id)||null;}
function addItem(id){cart.items[id]=(cart.items[id]||0)+1; renderCart(); syncQty(id);}
function incItem(id){addItem(id);}
function decItem(id){if(!cart.items[id])return; cart.items[id]--; if(cart.items[id]<=0) delete cart.items[id]; renderCart(); syncQty(id);}
function newOrder(){ cart={items:{}}; document.getElementById('note').value=''; renderAll(); }
function syncQty(id){var q=document.getElementById('qty-'+id); if(q){q.textContent=cart.items[id]||0;}}

/* ====== 渲染 ====== */
function itemCard(it){
  var qty = cart.items[it.id]||0;
  var nm = (LANG==='en')?(it.nameEn||it.name):(LANG==='vi'?(it.nameVi||it.name):it.name);
  var en = (LANG==='zh')?('<br><span class="sub">'+(it.nameEn||'')+'</span>'):'';
  return ''+
  '<div class="item">'+
    '<div class="left">'+
      '<div class="title">'+nm+en+'</div>'+
      '<div class="sub">'+settings.currency+' '+fmt(it.price)+'/份</div>'+
    '</div>'+
    '<div style="display:flex;flex-direction:column;align-items:center;gap:6px">'+
      '<div style="display:flex;gap:8px;align-items:center">'+
        '<button class="btn small" onclick="decItem(\''+it.id+'\')">-</button>'+
        '<div id="qty-'+it.id+'" class="qty">'+qty+'</div>'+
        '<button class="btn small" onclick="incItem(\''+it.id+'\')">+</button>'+
      '</div>'+
      '<button class="btn add" onclick="addItem(\''+it.id+'\')">加入</button>'+
    '</div>'+
  '</div>';
}
function renderList(t,list){ document.getElementById(t).innerHTML=list.map(itemCard).join(''); }
function renderAll(){
  renderList('menuWonton', WONTON);
  renderList('menuDrinks', DRINKS);
  renderList('menuAunt', AUNT);
  renderCart();  updateStatsBox();
}
function renderCart(){
  var c=document.getElementById('cart'); c.innerHTML='';
  var subtotal=0, pieces=0;
  for(var id in cart.items){
    var qty=cart.items[id]; var it=findItem(id); if(!it) continue;
    pieces += qty; var line=it.price*qty; subtotal+=line;
    var row=document.createElement('div'); row.className="item";
    row.innerHTML =
      '<div class="left"><div class="title">'+(it.name)+'</div>'+
      '<div class="sub">'+(it.nameEn||'')+'</div></div>'+
      '<div style="text-align:right">'+
        '<div style="font-weight:800">'+settings.currency+' '+fmt(line)+'</div>'+
        '<div style="margin-top:6px">'+
          '<button class="btn small" onclick="incItem(\''+id+'\')">+</button> '+
          '<button class="btn small" onclick="decItem(\''+id+'\')">-</button>'+
        '</div>'+
      '</div>';
    c.appendChild(row);
  }
  var sum=document.createElement('div'); sum.className='sum';
  sum.innerHTML = '<div>件数：<b>'+pieces+'</b> · 合计：<b>'+settings.currency+' '+fmt(subtotal)+'</b></div>';
  c.appendChild(sum);
}

/* ====== 订单文本 ====== */
function buildOrderMessage(){
  const NL = '\r\n';
  let subtotal=0, lines=[];
  for (const id in cart.items){
    const qty = cart.items[id], it = findItem(id); if(!it) continue;
    const line = it.price * qty; subtotal += line;
    lines.push('- '+it.name+' × '+qty+' = '+settings.currency+' '+fmt(line));
  }
  const tableNo = document.getElementById('tableNo')?.value || '-';
  const type = document.getElementById('takeaway')?.checked ? '外带 Takeaway' : '堂食 Dine-in';
  const note = (document.getElementById('note')?.value || '').trim();
  let msg = [
    '【'+settings.cafeName+' '+settings.cafeNameEn+'】订单 / Order',
    '桌号 Table: '+tableNo, '类型 Type: '+type, '', '明细 / Items:'
  ].concat(lines);
  msg.push('', '小计 Subtotal: '+settings.currency+' '+fmt(subtotal));
  if(note) msg.push('备注 Notes: '+note);
  return msg.join(NL);
}

/* ====== 打印（WebView 稳定版） ====== */
function printReceiptSafe(){
  if(Object.keys(cart.items).length===0){ alert('没有项目 / No items'); return; }

  // 生成小票 HTML
  var subtotal=0, body='';
  for(var id in cart.items){
    var qty=cart.items[id], it=findItem(id); if(!it) continue;
    var line=it.price*qty; subtotal+=line;
    body += '<div>'+it.name+' × '+qty+' <span style="float:right">'+settings.currency+' '+fmt(line)+'</span>'+
            '<br><small style="color:#6b7280">'+(it.nameEn||'')+'</small></div>';
  }
  var total=subtotal;
  var html =
    '<div style="max-width:340px;margin:0 auto;font-size:13px;line-height:1.35;font-family:system-ui,-apple-system,Segoe UI,Roboto">'+
      '<div style="text-align:center;font-weight:800">'+settings.cafeName+'<br><small>'+settings.cafeNameEn+'</small></div>'+
      '<div>时间 Time: '+new Date().toLocaleString()+'</div>'+
      '<div>桌号 Table: '+(document.getElementById('tableNo').value || '-')+'</div>'+
      '<div>类型 Type: '+(document.getElementById('takeaway').checked?'外带 Takeaway':'堂食 Dine-in')+'</div>'+
      '<hr>'+body+'<hr>'+
      '<div style="font-weight:800">合计 Total: '+settings.currency+' '+fmt(total)+'</div>'+
      '<div style="text-align:center;margin-top:8px">'+settings.printFooter+'<br><small>'+settings.printFooterEn+'</small></div>'+
    '</div>';

  try{
    if(IS_WEBVIEW){
      const w = window.open('', '_blank');
      if(w){ w.document.write('<!doctype html><meta charset="utf-8"><title>Receipt</title>'+html); w.document.close(); }
      else alert('无法打开打印页面，请检查系统 WebView/浏览器权限');
    }else{
      const area = document.getElementById('print-area');
      const old = area.innerHTML; area.style.display='block'; area.innerHTML=html;
      window.print(); area.innerHTML=old; area.style.display='none';
    }
  }catch(e){ alert('打印不可用：'+e.message); }
}

/* ====== 统计存储 ====== */
const DB_KEY = 'lyx_sales_v1';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)||'[]'); }catch(e){ return []; } }
function saveDB(arr){ localStorage.setItem(DB_KEY, JSON.stringify(arr)); }
function pushSale(entry){ const arr = loadDB(); arr.push(entry); saveDB(arr); }

function todayKey(d=new Date()){ return d.toISOString().slice(0,10); }
function isSameWeek(a,b){
  const d1=new Date(a), d2=new Date(b);
  const day=(d)=>{ const t=new Date(d); t.setHours(0,0,0,0); const n=t.getDay()||7; t.setDate(t.getDate()-n+1); return t; };
  return day(d1).getTime()===day(d2).getTime();
}
function summarize(period='day'){
  const arr=loadDB();
  const today=new Date();
  let orders=0, qty=0, amount=0; let list=[];
  arr.forEach(e=>{
    const d=new Date(e.ts);
    const ok = (period==='day') ? (todayKey(d)===todayKey(today))
      : (period==='week' ? isSameWeek(d,today) : (d.getMonth()===today.getMonth() && d.getFullYear()===today.getFullYear()));
    if(ok){ orders++; qty+=e.qty; amount+=e.amount; list.push(e); }
  });
  return {orders,qty,amount,list};
}
function updateStatsBox(){
  const s=summarize('day');
  document.getElementById('statOrders').textContent=s.orders;
  document.getElementById('statQty').textContent=s.qty;
  document.getElementById('statAmount').textContent='RM '+fmt(s.amount);
}
function showDetails(){
  const s=summarize('day');
  if(!s.list.length){ document.getElementById('details').textContent='今日暂无明细。'; return; }
  const lines = s.list.map(e=>`${new Date(e.ts).toLocaleTimeString()} · 件数 ${e.qty} · 金额 RM ${fmt(e.amount)} · 桌 ${e.table||'-'}`);
  document.getElementById('details').innerHTML = lines.join('<br>');
}
function exportCSV(period){
  const s=summarize(period); if(!s.list.length){ alert('没有可导出的数据'); return; }
  const rows = [['时间','桌号','件数','金额','备注']].concat(
    s.list.map(e=>[new Date(e.ts).toLocaleString(), e.table||'', e.qty, fmt(e.amount), (e.note||'').replace(/\n/g,' ')])
  );
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lyx_${period}_${todayKey()}.csv`; a.click();
}

/* ====== 完成并统计 + 分享（群聊） ====== */
function completeAndShare(){
  if(Object.keys(cart.items).length===0){ alert('请先选择项目'); return; }

  let qty=0, amount=0;
  for(const id in cart.items){ const q=cart.items[id], it=findItem(id); if(!it) continue; qty+=q; amount+=q*it.price; }
  const entry = {
    ts: Date.now(),
    table: document.getElementById('tableNo').value||'-',
    qty, amount,
    note: (document.getElementById('note').value||'').trim()
  };
  pushSale(entry); updateStatsBox();

  const msg = buildOrderMessage();
  location.href = 'https://api.whatsapp.com/send?text='+encodeURIComponent(msg);

  newOrder();
}

/* ====== 删单（需密码） ====== */
const DEL_PWD = "Lyx115599$";
function secureDelete(){
  const pwd = prompt('请输入密码以清空今日交易记录（不可恢复）：');
  if(pwd!==DEL_PWD){ alert('密码错误'); return; }
  const arr = loadDB().filter(e => todayKey(new Date(e.ts)) !== todayKey(new Date())); // 仅清今天
  localStorage.setItem(DB_KEY, JSON.stringify(arr));
  updateStatsBox(); document.getElementById('details').innerHTML='';
  alert('已清除今日记录。');
}

/* ====== 启动 ====== */
renderAll(); setLang(LANG);
</script>
</body>
</html>  .title{font-weight:800}
  .sub{font-size:12px;color:var(--muted);line-height:1.2}
  .qty{min-width:44px;text-align:center;font-weight:800}
  .btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .btn.small{background:#f3f4f6}
  .btn.add{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
  .sticky{position:sticky;top:84px}
  .sum{border-top:none;margin-top:0;padding-top:0}

  /* 底部操作行：蓝25% + 绿75% */
  .actions-row{
    display:grid;grid-template-columns:var(--blue-fr)fr var(--green-fr)fr;gap:12px;margin:8px 0 0
  }
  .btn-xl{height:56px;font-weight:900;font-size:16px;border-radius:12px;display:flex;align-items:center;justify-content:center}
  .btn-blue{background:var(--blue);border-color:var(--blue);color:#fff}
  .btn-green{background:var(--green);border-color:var(--green);color:#fff}

  .kvs{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .kv{border:1px dashed var(--line);border-radius:12px;padding:12px;text-align:center;background:#fff}
  .kv b{font-size:18px}

  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  textarea{width:100%;min-height:76px;padding:10px;border:1px solid var(--line);border-radius:10px}
  .muted{color:var(--muted);font-size:12px}
  .danger{background:#ef4444;border-color:#ef4444;color:#fff}
</style>
</head>
<body>

<header>
  <div class="header-in">
    <div>
      <h1>龍運轩ᝰ美食中心<small>LYX Food Center</small></h1>
      <div class="muted" id="navcats">
        <a class="chip" href="#cat-wonton">龍兴记ᝰ云吞面</a>
        <a class="chip" href="#cat-drinks">饮料</a>
        <a class="chip" href="#cat-aunt">婶婶档</a>
      </div>
    </div>
    <div class="lang">
      <button id="lang-zh" class="active" onclick="setLang('zh')">中文</button>
      <button id="lang-en" onclick="setLang('en')">English</button>
      <button id="lang-vi" onclick="setLang('vi')">Tiếng Việt</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- 左：菜单 -->
  <section class="panel">
    <h3>点餐 / Order</h3>
    <div class="section">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin:4px 6px 12px">
        <label>桌号 Table<br>
          <input id="tableNo" style="width:140px;padding:10px;border-radius:12px;border:1px solid var(--line)">
        </label>
        <label class="btn" style="display:flex;gap:6px;align-items:center">
          <input type="checkbox" id="takeaway"> 外带 <span class="muted">/ Takeaway</span>
        </label>
      </div>

      <div id="cat-wonton" class="group-title">龍兴记ᝰ云吞面 / LYX Wonton Noodles</div>
      <div id="menuWonton" class="cards"></div>

      <div id="cat-drinks" class="group-title">饮料 / Drinks</div>
      <div id="menuDrinks" class="cards"></div>
      <div class="muted" style="margin:6px 8px">规则：所有饮料 冰 +RM0.20（罐装水固定 RM3.00，不加价）</div>

      <div id="cat-aunt" class="group-title">婶婶档 / Auntie's Stall</div>
      <div id="menuAunt" class="cards"></div>
    </div>
  </section>

  <!-- 右：订单 -->
  <aside class="panel sticky">
    <h3>订单 / Cart</h3>
    <div id="cart" class="section"></div>

    <div class="section">
      <label style="display:block">备注 Notes
        <textarea id="note" placeholder="例：少糖 / 少冰 / 加辣 ..."></textarea>
      </label>

      <!-- 只有这一排：蓝25% + 绿75% -->
      <div class="actions-row">
        <button class="btn btn-xl btn-blue" onclick="printReceiptSafe()">打印小票</button>
        <button class="btn btn-xl btn-green" onclick="completeAndShare()">完成并统计（群聊）</button>
      </div>

      <div class="tools">
        <button class="btn" onclick="newOrder()">新订单</button>
        <span class="muted">不会清理统计；仅清空购物车。</span>
      </div>
    </div>
  </aside>
</div>

<!-- 统计区 -->
<div class="wrap" style="grid-template-columns:1fr">
  <section class="panel">
    <h3>今日统计 / Today</h3>
    <div class="section">
      <div class="kvs">
        <div class="kv"><div>订单笔数</div><b id="statOrders">0</b></div>
        <div class="kv"><div>售出件数</div><b id="statQty">0</b></div>
        <div class="kv"><div>销售金额</div><b id="statAmount">RM 0.00</b></div>
      </div>
      <div class="tools">
        <button class="btn" onclick="showDetails()">查看明细</button>
        <button class="btn" onclick="exportCSV('day')">导出今日 CSV</button>
        <button class="btn" onclick="exportCSV('week')">导出本周 CSV</button>
        <button class="btn" onclick="exportCSV('month')">导出本月 CSV</button>
        <button class="btn danger" onclick="secureDelete()">删单（需密码）</button>
      </div>
      <div id="details" class="muted" style="margin-top:8px"></div>
    </div>
  </section>
</div>

<!-- 打印区（浏览器用） -->
<div id="print-area" style="display:none"></div>

<script>
/* ====== 基本配置 ====== */
var settings = {
  cafeName: "龍運轩ᝰ美食中心",
  cafeNameEn: "LYX Food Center",
  currency: "RM",
  whatsappList: ["60122847784","601161379373","60187794329","60187890583","60182925799"],
  printFooter: "谢谢惠顾，欢迎再次光临！",
  printFooterEn: "Thank you, please come again!"
};
function fmt(n){return (Math.round(n*100)/100).toFixed(2);}
const IS_WEBVIEW = /wv/.test(navigator.userAgent.toLowerCase());

/* ====== 多语言（极简） ====== */
var LANG = localStorage.getItem('lyx_lang') || 'zh';
function setLang(l){ LANG=l; localStorage.setItem('lyx_lang',l);
  document.querySelectorAll('.lang button').forEach(b=>b.classList.remove('active'));
  document.getElementById('lang-'+l).classList.add('active');
  renderAll();
}

/* ====== 菜单数据 ====== */
/* 龍兴记ᝰ云吞面 */
const WONTON = [
  {id:"w_dry_s",  name:"云吞面 干捞（小）",  nameEn:"Wonton Noodle Dry (S)", price:6.50, unit:"pc"},
  {id:"w_dry_m",  name:"云吞面 干捞（中）",  nameEn:"Wonton Noodle Dry (M)", price:7.50, unit:"pc"},
  {id:"w_dry_l",  name:"云吞面 干捞（大）",  nameEn:"Wonton Noodle Dry (L)", price:8.50, unit:"pc"},
  {id:"w_soup_s", name:"云吞面 汤（小）",     nameEn:"Wonton Noodle Soup (S)", price:6.50, unit:"pc"},
  {id:"w_soup_m", name:"云吞面 汤（中）",     nameEn:"Wonton Noodle Soup (M)", price:7.50, unit:"pc"},
  {id:"w_soup_l", name:"云吞面 汤（大）",     nameEn:"Wonton Noodle Soup (L)", price:8.50, unit:"pc"},
  {id:"wantan_dry", name:"云吞 干捞（一份）", nameEn:"Wantan Dry (1 portion)", price:5.00, unit:"pc"},
  {id:"wantan_soup",name:"云吞 汤（一份）",   nameEn:"Wantan Soup (1 portion)", price:5.00, unit:"pc"},
  {id:"addon_3",   name:"加料：云吞 ×3",    nameEn:"Add-on: 3 Wantans",      price:1.00, unit:"pc"}
];

/* 饮料（冰 +0.20；罐装固定 3.00） */
const DRINK_BASE = [
  ["咖啡",2.30],["咖啡C",2.50],["咖啡O",2.00],
  ["奶茶",2.30],["奶茶C",2.50],["奶茶咸C",2.50],
  ["Milo",2.60],["Milo C",2.80],["Milo O",2.60]
];
const CANNED = ["Coke","100 Plus","Sprite","Green Tea","Soya","Kikapo","Fanta","Xiao Mai Chao","罐装水"];
let DRINKS=[];
DRINK_BASE.forEach(([n,h])=>{
  let k=n.toLowerCase().replace(/\s+/g,'_');
  DRINKS.push({id:k+"_hot",name:n+"（热）",nameEn:n+" (Hot)",price:h,unit:"pc"});
  DRINKS.push({id:k+"_ice",name:n+"（冰）",nameEn:n+" (Iced)",price:h+0.20,unit:"pc"});
});
CANNED.forEach(n=>{
  let k=n.toLowerCase().replace(/[^a-z0-9]+/g,'_');
  DRINKS.push({id:k, name:n, nameEn:n, price:3.00, unit:"pc"});
});

/* 婶婶档（照片菜单） */
const AUNT = [
  {id:"bitter_bihun", name:"苦瓜米粉", nameEn:"Bitter Gourd Bihun", price:6.00, unit:"pc"},
  {id:"nasi_lemak_chicken", name:"Nasi Lemak（有鸡肉）", nameEn:"Nasi Lemak (Chicken)", price:6.00, unit:"pc"},
  {id:"nasi_lemak_egg", name:"Nasi Lemak（只有鸡蛋）", nameEn:"Nasi Lemak (Egg only)", price:3.00, unit:"pc"},
  {id:"mee_fung_kueh", name:"面粉粿", nameEn:"Mee Hoon Kueh", price:6.00, unit:"pc"},
  {id:"red_braised_rice", name:"红烧饭", nameEn:"Braised Rice", price:6.00, unit:"pc"},
  {id:"fish_porridge_pork", name:"鱼粥（猪肉）", nameEn:"Fish Porridge (Pork)", price:6.00, unit:"pc"},
  {id:"fish_porridge_chicken", name:"鱼粥（鸡肉）", nameEn:"Fish Porridge (Chicken)", price:6.00, unit:"pc"},
  {id:"mee_sua", name:"面线", nameEn:"Mee Sua", price:6.00, unit:"pc"},
  {id:"lor_meat_rice", name:"卤肉饭", nameEn:"Lor Meat Rice", price:6.00, unit:"pc"},
  {id:"kuey_teow_soup", name:"果条汤", nameEn:"Kuey Teow Soup", price:6.00, unit:"pc"}
];

/* ====== 运行态 ====== */
var cart={items:{}};

/* ====== 工具 ====== */
function allItems(){return WONTON.concat(DRINKS,AUNT);}
function findItem(id){return allItems().find(x=>x.id===id)||null;}
function addItem(id){cart.items[id]=(cart.items[id]||0)+1; renderCart(); syncQty(id);}
function incItem(id){addItem(id);}
function decItem(id){if(!cart.items[id])return; cart.items[id]--; if(cart.items[id]<=0) delete cart.items[id]; renderCart(); syncQty(id);}
function newOrder(){ cart={items:{}}; document.getElementById('note').value=''; renderAll(); }
function syncQty(id){var q=document.getElementById('qty-'+id); if(q){q.textContent=cart.items[id]||0;}}

/* ====== 渲染 ====== */
function itemCard(it){
  var qty = cart.items[it.id]||0;
  var nm = (LANG==='en')?(it.nameEn||it.name):(LANG==='vi'?(it.nameVi||it.name):it.name);
  var en = (LANG==='zh')?('<br><span class="sub">'+(it.nameEn||'')+'</span>'):'';
  return ''+
  '<div class="item">'+
    '<div class="left">'+
      '<div class="title">'+nm+en+'</div>'+
      '<div class="sub">'+settings.currency+' '+fmt(it.price)+'/份</div>'+
    '</div>'+
    '<div>'+
      '<button class="btn small" onclick="decItem(\''+it.id+'\')">-</button>'+
      '<div id="qty-'+it.id+'" class="qty">'+qty+'</div>'+
      '<button class="btn small" onclick="incItem(\''+it.id+'\')">+</button><br>'+
      '<button class="btn add" onclick="addItem(\''+it.id+'\')">加入</button>'+
    '</div>'+
  '</div>';
}
function renderList(t,list){ document.getElementById(t).innerHTML=list.map(itemCard).join(''); }
function renderAll(){
  renderList('menuWonton', WONTON);
  renderList('menuDrinks', DRINKS);
  renderList('menuAunt', AUNT);
  renderCart();  updateStatsBox();
}
function renderCart(){
  var c=document.getElementById('cart'); c.innerHTML='';
  var subtotal=0, pieces=0;
  for(var id in cart.items){
    var qty=cart.items[id]; var it=findItem(id); if(!it) continue;
    pieces += qty; var line=it.price*qty; subtotal+=line;
    var row=document.createElement('div'); row.className="item";
    row.innerHTML =
      '<div class="left"><div class="title">'+(it.name)+'</div>'+
      '<div class="sub">'+(it.nameEn||'')+'</div></div>'+
      '<div style="text-align:right">'+
        '<div style="font-weight:800">'+settings.currency+' '+fmt(line)+'</div>'+
        '<div style="margin-top:6px">'+
          '<button class="btn small" onclick="incItem(\''+id+'\')">+</button> '+
          '<button class="btn small" onclick="decItem(\''+id+'\')">-</button>'+
        '</div>'+
      '</div>';
    c.appendChild(row);
  }
  var sum=document.createElement('div'); sum.className='sum';
  sum.innerHTML = '<div>件数：<b>'+pieces+'</b> · 合计：<b>'+settings.currency+' '+fmt(subtotal)+'</b></div>';
  c.appendChild(sum);
}

/* ====== 订单文本 ====== */
function buildOrderMessage(){
  const NL = '\r\n';
  let subtotal=0, lines=[];
  for (const id in cart.items){
    const qty = cart.items[id], it = findItem(id); if(!it) continue;
    const line = it.price * qty; subtotal += line;
    lines.push('- '+it.name+' × '+qty+' = '+settings.currency+' '+fmt(line));
  }
  const tableNo = document.getElementById('tableNo')?.value || '-';
  const type = document.getElementById('takeaway')?.checked ? '外带 Takeaway' : '堂食 Dine-in';
  const note = (document.getElementById('note')?.value || '').trim();
  let msg = [
    '【'+settings.cafeName+' '+settings.cafeNameEn+'】订单 / Order',
    '桌号 Table: '+tableNo, '类型 Type: '+type, '', '明细 / Items:'
  ].concat(lines);
  msg.push('', '小计 Subtotal: '+settings.currency+' '+fmt(subtotal));
  if(note) msg.push('备注 Notes: '+note);
  return msg.join(NL);
}

/* ====== 打印（WebView 稳定版） ====== */
function printReceiptSafe(){
  if(Object.keys(cart.items).length===0){ alert('没有项目 / No items'); return; }

  // 生成小票 HTML
  var subtotal=0, body='';
  for(var id in cart.items){
    var qty=cart.items[id], it=findItem(id); if(!it) continue;
    var line=it.price*qty; subtotal+=line;
    body += '<div>'+it.name+' × '+qty+' <span style="float:right">'+settings.currency+' '+fmt(line)+'</span>'+
            '<br><small style="color:#6b7280">'+(it.nameEn||'')+'</small></div>';
  }
  var total=subtotal;
  var html =
    '<div style="max-width:340px;margin:0 auto;font-size:13px;line-height:1.35;font-family:system-ui,-apple-system,Segoe UI,Roboto">'+
      '<div style="text-align:center;font-weight:800">'+settings.cafeName+'<br><small>'+settings.cafeNameEn+'</small></div>'+
      '<div>时间 Time: '+new Date().toLocaleString()+'</div>'+
      '<div>桌号 Table: '+(document.getElementById('tableNo').value || '-')+'</div>'+
      '<div>类型 Type: '+(document.getElementById('takeaway').checked?'外带 Takeaway':'堂食 Dine-in')+'</div>'+
      '<hr>'+body+'<hr>'+
      '<div style="font-weight:800">合计 Total: '+settings.currency+' '+fmt(total)+'</div>'+
      '<div style="text-align:center;margin-top:8px">'+settings.printFooter+'<br><small>'+settings.printFooterEn+'</small></div>'+
    '</div>';

  try{
    if(IS_WEBVIEW){
      const w = window.open('', '_blank');
      if(w){ w.document.write('<!doctype html><meta charset="utf-8"><title>Receipt</title>'+html); w.document.close(); }
      else alert('无法打开打印页面，请检查系统 WebView/浏览器权限');
    }else{
      const area = document.getElementById('print-area');
      const old = area.innerHTML; area.style.display='block'; area.innerHTML=html;
      window.print(); area.innerHTML=old; area.style.display='none';
    }
  }catch(e){ alert('打印不可用：'+e.message); }
}

/* ====== 统计存储 ====== */
const DB_KEY = 'lyx_sales_v1';
function loadDB(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)||'[]'); }catch(e){ return []; } }
function saveDB(arr){ localStorage.setItem(DB_KEY, JSON.stringify(arr)); }
function pushSale(entry){ const arr = loadDB(); arr.push(entry); saveDB(arr); }

function todayKey(d=new Date()){ return d.toISOString().slice(0,10); }
function isSameWeek(a,b){
  const d1=new Date(a), d2=new Date(b);
  const day=(d)=>{ const t=new Date(d); t.setHours(0,0,0,0); const n=t.getDay()||7; t.setDate(t.getDate()-n+1); return t; };
  return day(d1).getTime()===day(d2).getTime();
}
function summarize(period='day'){
  const arr=loadDB();
  const today=new Date();
  let orders=0, qty=0, amount=0; let list=[];
  arr.forEach(e=>{
    const d=new Date(e.ts);
    const ok = (period==='day') ? (todayKey(d)===todayKey(today))
      : (period==='week' ? isSameWeek(d,today) : (d.getMonth()===today.getMonth() && d.getFullYear()===today.getFullYear()));
    if(ok){ orders++; qty+=e.qty; amount+=e.amount; list.push(e); }
  });
  return {orders,qty,amount,list};
}
function updateStatsBox(){
  const s=summarize('day');
  document.getElementById('statOrders').textContent=s.orders;
  document.getElementById('statQty').textContent=s.qty;
  document.getElementById('statAmount').textContent='RM '+fmt(s.amount);
}
function showDetails(){
  const s=summarize('day');
  if(!s.list.length){ document.getElementById('details').textContent='今日暂无明细。'; return; }
  const lines = s.list.map(e=>`${new Date(e.ts).toLocaleTimeString()} · 件数 ${e.qty} · 金额 RM ${fmt(e.amount)} · 桌 ${e.table||'-'}`);
  document.getElementById('details').innerHTML = lines.join('<br>');
}
function exportCSV(period){
  const s=summarize(period); if(!s.list.length){ alert('没有可导出的数据'); return; }
  const rows = [['时间','桌号','件数','金额','备注']].concat(
    s.list.map(e=>[new Date(e.ts).toLocaleString(), e.table||'', e.qty, fmt(e.amount), (e.note||'').replace(/\n/g,' ')])
  );
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lyx_${period}_${todayKey()}.csv`; a.click();
}

/* ====== 完成并统计 + 分享（群聊） ====== */
function completeAndShare(){
  if(Object.keys(cart.items).length===0){ alert('请先选择项目'); return; }

  // 统计当次单
  let qty=0, amount=0;
  for(const id in cart.items){ const q=cart.items[id], it=findItem(id); if(!it) continue; qty+=q; amount+=q*it.price; }
  const entry = {
    ts: Date.now(),
    table: document.getElementById('tableNo').value||'-',
    qty, amount,
    note: (document.getElementById('note').value||'').trim()
  };
  pushSale(entry); updateStatsBox();

  // 分享到 WhatsApp（单跳分享页，用户可选群/联系人）
  const msg = buildOrderMessage();
  location.href = 'https://api.whatsapp.com/send?text='+encodeURIComponent(msg);

  // 清空购物车（不清统计）
  newOrder();
}

/* ====== 删单（需密码） ====== */
const DEL_PWD = "Lyx115599$";
function secureDelete(){
  const pwd = prompt('请输入密码以清空今日交易记录（不可恢复）：');
  if(pwd!==DEL_PWD){ alert('密码错误'); return; }
  const arr = loadDB().filter(e => todayKey(new Date(e.ts)) !== todayKey(new Date())); // 保留非今日
  localStorage.setItem(DB_KEY, JSON.stringify(arr));
  updateStatsBox(); document.getElementById('details').innerHTML='';
  alert('已清除今日记录。');
}

/* ====== 启动 ====== */
renderAll(); setLang(LANG);
</script>
</body>
</html>
